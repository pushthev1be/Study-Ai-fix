<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyMaster AI - Complete Learning Platform</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #f9fafc;
            --light: #0f172a;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-bg: rgba(255, 255, 255, 0.05); /* Added for better contrast */
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f172a, #1e293b, #334155);
            min-height: 100vh;
            color: var(--dark);
            overflow-x: hidden;
        }

        .bg-gradient {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a, #1e293b, #334155);
            z-index: -2;
        }

        .bg-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.3) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(6, 182, 212, 0.3) 0%, transparent 50%),
                        radial-gradient(circle at 40% 40%, rgba(16, 185, 129, 0.2) 0%, transparent 50%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            to { transform: rotate(360deg); }
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        h1 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, #fff, var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .hero {
            text-align: center;
            padding: 6rem 0;
        }

        .hero-title {
            font-size: 4rem;
            font-weight: 800;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, #fff, var(--secondary), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.1;
        }

        .hero-subtitle {
            font-size: 1.5rem;
            opacity: 0.8;
            margin-bottom: 3rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .pricing-comparison {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 3rem 0;
            flex-wrap: wrap;
        }

        .competitor, .us {
            padding: 1rem 2rem;
            background: var(--glass);
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .us {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(6, 182, 212, 0.1));
            border-color: var(--success);
        }

        .strike {
            color: var(--danger);
        }

        .check {
            color: var(--success);
        }

        .btn-cta {
            padding: 1.25rem 3rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.25rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 2rem 0 1rem 0;
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        .btn-cta:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.4);
        }

        .no-card {
            opacity: 0.7;
            font-size: 0.9rem;
        }

        .landing-page {
            min-height: 100vh;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: var(--glass);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid var(--glass-border);
        }

        .dashboard {
            display: none;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem 1.5rem;
            background: var(--glass);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid var(--glass-border);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .streak-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(251, 146, 60, 0.1);
            border: 1px solid rgba(251, 146, 60, 0.3);
            border-radius: 20px;
        }

        .streak-number {
            font-weight: bold;
            color: var(--warning);
        }

        .main-layout {
            display: grid;
            grid-template-columns: 320px 1fr 380px;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1400px) {
            .main-layout {
                grid-template-columns: 320px 1fr;
            }
            .right-sidebar {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .hero-title {
                font-size: 2.5rem;
            }
            .pricing-comparison {
                flex-direction: column;
                align-items: center;
            }
        }

        .card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid var(--glass-border);
            padding: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .left-sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .upload-area {
            border: 2px dashed rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
            transform: scale(1.02);
        }

        input[type="file"] {
            display: none;
        }

        .file-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .file-name {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            font-size: 0.9rem;
        }

        .file-size {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-right: 0.5rem;
        }

        .remove-btn {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--danger);
            border-radius: 6px;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .remove-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .study-modes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .mode-btn {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9rem;
            color: inherit;
        }

        .mode-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .mode-btn.active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(6, 182, 212, 0.2));
            border-color: var(--primary);
        }

        .mode-btn div:first-child {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 1rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid var(--glass-border);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .demo-notice {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.1), rgba(239, 68, 68, 0.1));
            border: 1px solid var(--warning);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .toast {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success {
            background: rgba(16, 185, 129, 0.9);
            border: 1px solid var(--success);
        }

        .toast.error {
            background: rgba(239, 68, 68, 0.9);
            border: 1px solid var(--danger);
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Removed duplicate flashcard styles - using enhanced version below */

        .theme-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .progress-ring {
            width: 120px;
            height: 120px;
            margin: 0 auto 1rem;
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .progress-ring .bg {
            stroke: rgba(255, 255, 255, 0.1);
        }

        .progress-ring .progress {
            stroke: var(--primary);
            stroke-dasharray: 339.292;
            stroke-dashoffset: 339.292;
            transition: stroke-dashoffset 0.5s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid var(--glass-border);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .content-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--glass-border);
        }

        .tab {
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            color: inherit;
            font-size: 0.9rem;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .tab-content {
            display: none;
            min-height: 300px;
            padding: 1.5rem;
        }

        .tab-content.active {
            display: block !important;
        }

        .chat-container {
            height: 400px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            margin-bottom: 1rem;
            max-height: 300px;
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 10px;
            max-width: 80%;
        }

        .message.user {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            margin-left: auto;
        }

        .message.ai {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
        }

        .chat-input-container {
            display: flex;
            gap: 0.5rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 0.9rem;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .send-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            background: var(--primary-dark);
        }

        .study-plan {
            max-height: 300px;
            overflow-y: auto;
        }

        .study-plan-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .study-plan-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .study-plan-check {
            width: 20px;
            height: 20px;
            border: 2px solid var(--glass-border);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .study-plan-check.checked {
            background: var(--success);
            border-color: var(--success);
        }

        .study-plan-check.checked::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            position: relative;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .auth-toggle {
            text-align: center;
            margin-top: 1rem;
        }

        .auth-toggle a {
            color: var(--primary);
            text-decoration: none;
            cursor: pointer;
        }

        .auth-toggle a:hover {
            text-decoration: underline;
        }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .hidden {
            display: none !important;
        }

        .error-message {
            color: var(--danger);
            font-size: 0.9rem;
            margin-top: 0.5rem;
            text-align: center;
        }

        .success-message {
            color: var(--success);
            font-size: 0.9rem;
            margin-top: 0.5rem;
            text-align: center;
        }

        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
        }

        /* Enhanced Flashcard Styles */
        .enhanced-flashcard {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            perspective: 1000px;
            position: relative;
        }

        .flashcard-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px 12px 0 0;
        }

        .card-meta {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            font-size: 0.8rem;
        }

        .difficulty-indicator {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            border: 1px solid var(--primary);
        }

        .category-tag {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
        }

        .importance-stars {
            color: #fbbf24;
            font-size: 1.1rem;
        }

        .memory-tip, .visual-tip, .mnemonic-tip {
            background: rgba(255, 255, 255, 0.15);
            padding: 1rem;
            margin: 0.75rem 0;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            font-size: 0.95rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .visual-tip {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .mnemonic-tip {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .connections {
            margin: 1rem 0;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 0.9rem;
            clear: both;
        }

        .connection-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .connection-tag {
            background: rgba(6, 182, 212, 0.2);
            color: #67e8f9;
            padding: 0.3rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            border: 1px solid #06b6d4;
            white-space: nowrap;
        }

        .misconceptions {
            background: rgba(239, 68, 68, 0.1);
            padding: 0.75rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 3px solid #ef4444;
            font-size: 0.9rem;
            clear: both;
        }

        .misconceptions ul {
            margin: 0.5rem 0 0 0;
            padding-left: 1.2rem;
        }

        .misconceptions li {
            margin-bottom: 0.3rem;
            line-height: 1.4;
        }

        .practice-question {
            background: rgba(168, 85, 247, 0.1);
            padding: 0.75rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 3px solid #a855f7;
            font-size: 0.9rem;
            clear: both;
        }

        .practice-q {
            margin-top: 0.5rem;
            font-style: italic;
            color: #e9d5ff;
            line-height: 1.4;
        }

        .examples {
            margin: 1rem 0;
            padding: 0.75rem;
            background: rgba(34, 197, 94, 0.1);
            border-radius: 8px;
            border-left: 3px solid #22c55e;
            font-size: 0.9rem;
            clear: both;
        }

        .examples ul {
            margin: 0.5rem 0 0 0;
            padding-left: 1.2rem;
        }

        .examples li {
            margin-bottom: 0.3rem;
            line-height: 1.4;
        }

        .feedback-btn.easy {
            background: rgba(34, 197, 94, 0.2);
            border-color: var(--success);
            color: var(--success);
        }

        .feedback-btn.medium {
            background: rgba(251, 191, 36, 0.2);
            border-color: #fbbf24;
            color: #fbbf24;
        }

        .feedback-btn.hard {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }

        .card-progress {
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 0 0 12px 12px;
            border-top: 1px solid var(--glass-border);
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
        }

        .next-review {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .connection-status.connected {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        /* Flashcard Container and Card Layout */
        .flashcard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            padding: 2rem 0;
            max-width: 1400px;
            margin: 0 auto;
        }

        .flashcard {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            perspective: 1000px;
            position: relative;
            min-height: 450px;
            backdrop-filter: blur(10px);
            overflow: visible;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }

        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 2rem;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(51, 65, 85, 0.95));
            border: 1px solid rgba(148, 163, 184, 0.2);
            backdrop-filter: blur(15px);
        }

        .flashcard-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95));
        }

        .card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            text-align: left;
            padding: 1rem;
            margin-bottom: 1rem;
            overflow-y: auto;
            word-wrap: break-word;
            max-width: 100%;
            line-height: 1.6;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
        }

        .card-content::-webkit-scrollbar {
            width: 8px;
        }

        .card-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .card-content::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .definition {
            margin-bottom: 1rem;
            font-size: 1rem;
            line-height: 1.5;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: auto; /* Pushes actions to the bottom */
            padding-top: 1rem; /* Add some space above actions */
        }

        .flip-btn, .feedback-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .flip-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .feedback-btn.correct {
            background: rgba(34, 197, 94, 0.2);
            border-color: var(--success);
        }

        .feedback-btn.correct:hover {
            background: rgba(34, 197, 94, 0.3);
        }

        .feedback-btn.incorrect {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
        }

        .feedback-btn.incorrect:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        /* Practice Question Styles */
        .question-container.correct {
            border: 2px solid var(--success);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.2);
        }

        .question-container.incorrect {
            border: 2px solid #ef4444;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.2);
        }

        .option-label:hover {
            background: rgba(255, 255, 255, 0.1) !important;
        }

        .check-btn:hover, .hint-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .question-feedback {
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced Summary Styles */
        .enhanced-summary {
            line-height: 1.6;
        }

        .summary-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid var(--primary);
        }

        .summary-meta {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .difficulty-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.8rem;
        }

        .difficulty-badge.beginner {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .difficulty-badge.intermediate {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }

        .difficulty-badge.advanced {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .concepts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .concept-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
        }

        .concept-card h5 {
            margin: 0 0 0.5rem 0;
            color: var(--primary);
        }

        .importance-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .importance-badge.high {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .importance-badge.medium {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .importance-badge.low {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .objectives-list, .key-points-list, .mistakes-list {
            padding-left: 1.5rem;
        }

        .objectives-list li, .key-points-list li {
            margin-bottom: 0.5rem;
        }

        .strategy-content {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 6px;
            margin-top: 0.5rem;
        }

        /* Enhanced Flashcard Styles */
        .enhanced-flashcard {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            perspective: 1000px;
            position: relative;
        }

        .flashcard-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px 12px 0 0;
        }

        .card-meta {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            font-size: 0.8rem;
        }

        .difficulty-indicator {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            border: 1px solid var(--primary);
        }

        .category-tag {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
        }

        .importance-stars {
            color: #fbbf24;
            font-size: 1.1rem;
        }

        .memory-tip, .visual-tip, .mnemonic-tip {
            background: rgba(255, 255, 255, 0.15);
            padding: 1rem;
            margin: 0.75rem 0;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            font-size: 0.95rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .visual-tip {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .mnemonic-tip {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .connections {
            background: rgba(6, 182, 212, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            border-left: 3px solid #06b6d4;
        }

        .connection-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .connection-tag {
            background: rgba(6, 182, 212, 0.2);
            border: 1px solid #06b6d4;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            color: #67e8f9;
        }

        .misconceptions {
            background: rgba(239, 68, 68, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            border-left: 3px solid #ef4444;
        }

        .misconceptions strong {
            color: #f87171;
        }

        .misconceptions ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }

        .misconceptions li {
            margin: 0.3rem 0;
            color: #fecaca;
            line-height: 1.4;
        }

        .practice-question {
            background: rgba(168, 85, 247, 0.1);
            padding: 0.75rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 3px solid #a855f7;
            font-size: 0.9rem;
            clear: both;
        }

        .practice-q {
            margin-top: 0.5rem;
            font-style: italic;
            color: #e9d5ff;
            line-height: 1.4;
        }

        .examples {
            margin: 1rem 0;
            padding: 0.75rem;
            background: rgba(34, 197, 94, 0.1);
            border-radius: 8px;
            border-left: 3px solid #22c55e;
            font-size: 0.9rem;
            clear: both;
        }

        .examples ul {
            margin: 0.5rem 0 0 0;
            padding-left: 1.2rem;
        }

        .examples li {
            margin-bottom: 0.3rem;
            line-height: 1.4;
        }

        .feedback-btn.easy {
            background: rgba(34, 197, 94, 0.2);
            border-color: var(--success);
            color: var(--success);
        }

        .feedback-btn.medium {
            background: rgba(251, 191, 36, 0.2);
            border-color: #fbbf24;
            color: #fbbf24;
        }

        .feedback-btn.hard {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }

        .card-progress {
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 0 0 12px 12px;
            border-top: 1px solid var(--glass-border);
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
        }

        .next-review {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .connection-status.connected {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        /* Flashcard Container and Card Layout */
        .flashcard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            padding: 2rem 0;
            max-width: 1400px;
            margin: 0 auto;
        }

        .flashcard {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            perspective: 1000px;
            position: relative;
            min-height: 450px;
            backdrop-filter: blur(10px);
            overflow: visible;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }

        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 2rem;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(51, 65, 85, 0.95));
            border: 1px solid rgba(148, 163, 184, 0.2);
            backdrop-filter: blur(15px);
        }

        .flashcard-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95));
        }

        .card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            text-align: left;
            padding: 1rem;
            margin-bottom: 1rem;
            overflow-y: auto;
            word-wrap: break-word;
            max-width: 100%;
            line-height: 1.6;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
        }

        .card-content::-webkit-scrollbar {
            width: 8px;
        }

        .card-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .card-content::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .definition {
            margin-bottom: 1rem;
            font-size: 1rem;
            line-height: 1.5;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: auto; /* Pushes actions to the bottom */
            padding-top: 1rem; /* Add some space above actions */
        }

        .flip-btn, .feedback-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .flip-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .feedback-btn.correct {
            background: rgba(34, 197, 94, 0.2);
            border-color: var(--success);
        }

        .feedback-btn.correct:hover {
            background: rgba(34, 197, 94, 0.3);
        }

        .feedback-btn.incorrect {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
        }

        .feedback-btn.incorrect:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        /* Practice Question Styles */
        .question-container.correct {
            border: 2px solid var(--success);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.2);
        }

        .question-container.incorrect {
            border: 2px solid #ef4444;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.2);
        }

        .option-label:hover {
            background: rgba(255, 255, 255, 0.1) !important;
        }

        .check-btn:hover, .hint-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .question-feedback {
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced Summary Styles */
        .enhanced-summary {
            line-height: 1.6;
        }

        .summary-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid var(--primary);
        }

        .summary-meta {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .difficulty-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.8rem;
        }

        .difficulty-badge.beginner {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .difficulty-badge.intermediate {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }

        .difficulty-badge.advanced {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .concepts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .concept-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
        }

        .concept-card h5 {
            margin: 0 0 0.5rem 0;
            color: var(--primary);
        }

        .importance-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .importance-badge.high {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .importance-badge.medium {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .importance-badge.low {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .objectives-list, .key-points-list, .mistakes-list {
            padding-left: 1.5rem;
        }

        .objectives-list li, .key-points-list li {
            margin-bottom: 0.5rem;
        }

        .strategy-content {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 6px;
            margin-top: 0.5rem;
        }

        /* Enhanced Flashcard Styles */
        .enhanced-flashcard {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            perspective: 1000px;
            position: relative;
        }

        .flashcard-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px 12px 0 0;
        }

        .card-meta {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            font-size: 0.8rem;
        }

        .difficulty-indicator {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            border: 1px solid var(--primary);
        }

        .category-tag {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
        }

        .importance-stars {
            color: #fbbf24;
            font-size: 1.1rem;
        }

        .memory-tip, .visual-tip, .mnemonic-tip {
            background: rgba(255, 255, 255, 0.15);
            padding: 1rem;
            margin: 0.75rem 0;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            font-size: 0.95rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .visual-tip {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .mnemonic-tip {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .connections {
            background: rgba(6, 182, 212, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            border-left: 3px solid #06b6d4;
        }

        .connection-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .connection-tag {
            background: rgba(6, 182, 212, 0.2);
            border: 1px solid #06b6d4;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            color: #67e8f9;
        }

        .misconceptions {
            background: rgba(239, 68, 68, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            border-left: 3px solid #ef4444;
        }

        .misconceptions strong {
            color: #f87171;
        }

        .misconceptions ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }

        .misconceptions li {
            margin: 0.3rem 0;
            color: #fecaca;
            line-height: 1.4;
        }

        .practice-question {
            background: rgba(168, 85, 247, 0.1);
            padding: 0.75rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 3px solid #a855f7;
            font-size: 0.9rem;
            clear: both;
        }

        .practice-q {
            margin-top: 0.5rem;
            font-style: italic;
            color: #e9d5ff;
            line-height: 1.4;
        }

        .examples {
            margin: 1rem 0;
            padding: 0.75rem;
            background: rgba(34, 197, 94, 0.1);
            border-radius: 8px;
            border-left: 3px solid #22c55e;
            font-size: 0.9rem;
            clear: both;
        }

        .examples ul {
            margin: 0.5rem 0 0 0;
            padding-left: 1.2rem;
        }

        .examples li {
            margin-bottom: 0.3rem;
            line-height: 1.4;
        }

        .feedback-btn.easy {
            background: rgba(34, 197, 94, 0.2);
            border-color: var(--success);
            color: var(--success);
        }

        .feedback-btn.medium {
            background: rgba(251, 191, 36, 0.2);
            border-color: #fbbf24;
            color: #fbbf24;
        }

        .feedback-btn.hard {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }

        .card-progress {
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 0 0 12px 12px;
            border-top: 1px solid var(--glass-border);
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
        }

        .next-review {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .connection-status.connected {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        /* Flashcard Container and Card Layout */
        .flashcard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            padding: 2rem 0;
            max-width: 1400px;
            margin: 0 auto;
        }

        .flashcard {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            perspective: 1000px;
            position: relative;
            min-height: 450px;
            backdrop-filter: blur(10px);
            overflow: visible;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }

        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 2rem;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(51, 65, 85, 0.95));
            border: 1px solid rgba(148, 163, 184, 0.2);
            backdrop-filter: blur(15px);
        }

        .flashcard-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95));
        }

        .card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            text-align: left;
            padding: 1rem;
            margin-bottom: 1rem;
            overflow-y: auto;
            word-wrap: break-word;
            max-width: 100%;
            line-height: 1.6;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
        }

        .card-content::-webkit-scrollbar {
            width: 8px;
        }

        .card-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .card-content::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .definition {
            margin-bottom: 1rem;
            font-size: 1rem;
            line-height: 1.5;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: auto; /* Pushes actions to the bottom */
            padding-top: 1rem; /* Add some space above actions */
        }

        .flip-btn, .feedback-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .flip-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .feedback-btn.correct {
            background: rgba(34, 197, 94, 0.2);
            border-color: var(--success);
        }

        .feedback-btn.correct:hover {
            background: rgba(34, 197, 94, 0.3);
        }

        .feedback-btn.incorrect {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
        }

        .feedback-btn.incorrect:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        /* Practice Question Styles */
        .question-container.correct {
            border: 2px solid var(--success);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.2);
        }

        .question-container.incorrect {
            border: 2px solid #ef4444;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.2);
        }

        .option-label:hover {
            background: rgba(255, 255, 255, 0.1) !important;
        }

        .check-btn:hover, .hint-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .question-feedback {
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced Summary Styles */
        .enhanced-summary {
            line-height: 1.6;
        }

        .summary-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid var(--primary);
        }

        .summary-meta {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .difficulty-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.8rem;
        }

        .difficulty-badge.beginner {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .difficulty-badge.intermediate {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid #fbbf24;
        }

        .difficulty-badge.advanced {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .concepts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .concept-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
        }

        .concept-card h5 {
            margin: 0 0 0.5rem 0;
            color: var(--primary);
        }

        .importance-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .importance-badge.high {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .importance-badge.medium {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .importance-badge.low {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .objectives-list, .key-points-list, .mistakes-list {
            padding-left: 1.5rem;
        }

        .objectives-list li, .key-points-list li {
            margin-bottom: 0.5rem;
        }

        .strategy-content {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 6px;
            margin-top: 0.5rem;
        }

        /* Enhanced Flashcard Styles */
        .enhanced-flashcard {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            perspective: 1000px;
            position: relative;
        }

        .flashcard-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px 12px 0 0;
        }

        .card-meta {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            font-size: 0.8rem;
        }

        .difficulty-indicator {
            background: rgba(99, 102, 241, 0.2);
            color: var(--primary);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            border: 1px solid var(--primary);
        }

        .category-tag {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
        }

        .importance-stars {
            color: #fbbf24;
            font-size: 1.1rem;
        }

        .memory-tip, .visual-tip, .mnemonic-tip {
            background: rgba(255, 255, 255, 0.15);
            padding: 1rem;
            margin: 0.75rem 0;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            font-size: 0.95rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .visual-tip {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .mnemonic-tip {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .connections {
            background: rgba(6, 182, 212, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            border-left: 3px solid #06b6d4;
        }

        .connection-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .connection-tag {
            background: rgba(6, 182, 212, 0.2);
            border: 1px solid #06b6d4;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            color: #67e8f9;
        }

        .misconceptions {
            background: rgba(239, 68, 68, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            border-left: 3px solid #ef4444;
        }

        .misconceptions strong {
            color: #f87171;
        }

        .misconceptions ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }

        .misconceptions li {
            margin: 0.3rem 0;
            color: #fecaca;
            line-height: 1.4;
        }

        .practice-question {
            background: rgba(168, 85, 247, 0.1);
            padding: 0.75rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 3px solid #a855f7;
            font-size: 0.9rem;
            clear: both;
        }

        .practice-q {
            margin-top: 0.5rem;
            font-style: italic;
            color: #e9d5ff;
            line-height: 1.4;
        }

        .examples {
            margin: 1rem 0;
            padding: 0.75rem;
            background: rgba(34, 197, 94, 0.1);
            border-radius: 8px;
            border-left: 3px solid #22c55e;
            font-size: 0.9rem;
            clear: both;
        }

        .examples ul {
            margin: 0.5rem 0 0 0;
            padding-left: 1.2rem;
        }

        .examples li {
            margin-bottom: 0.3rem;
            line-height: 1.4;
        }

        .feedback-btn.easy {
            background: rgba(34, 197, 94, 0.2);
            border-color: var(--success);
            color: var(--success);
        }

        .feedback-btn.medium {
            background: rgba(251, 191, 36, 0.2);
            border-color: #fbbf24;
            color: #fbbf24;
        }

        .feedback-btn.hard {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }

        .card-progress {
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 0 0 12px 12px;
            border-top: 1px solid var(--glass-border);
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
        }

        .next-review {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .connection-status.connected {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--danger);
            color: var(--danger);
        }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>

    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status disconnected">
        Connecting to backend...
    </div>

    <!-- Landing Page -->
    <div id="landingPage" class="landing-page">
        <div class="container">
            <nav class="navbar">
                <div class="logo">
                    <div class="logo-icon">ðŸ§ </div>
                    <h1>StudyMaster AI</h1>
                </div>
                <div class="nav-actions">
                    <button class="btn" onclick="showLogin()">Login</button>
                    <button class="btn-primary" onclick="showRegister()" style="width: auto; padding: 0.5rem 1rem;">Start Free Trial</button>
                </div>
            </nav>

            <section class="hero">
                <h1 class="hero-title">Study Smarter with AI<br>50% Cheaper Than Others</h1>
                <p class="hero-subtitle">Only $5.99/month for unlimited AI tutoring, summaries, and practice questions</p>

                <div class="pricing-comparison">
                    <div class="competitor">
                        <span>Chegg: $14.95/mo</span>
                        <span class="strike">âŒ</span>
                    </div>
                    <div class="competitor">
                        <span>Course Hero: $39.95/mo</span>
                        <span class="strike">âŒ</span>
                    </div>
                    <div class="us">
                        <span>StudyMaster: $5.99/mo</span>
                        <span class="check">âœ…</span>
                    </div>
                </div>

                <button class="btn-cta" onclick="startFreeTrial()">Start 7-Day Free Trial</button>
                <p class="no-card">No credit card required</p>
            </section>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <div class="container">
            <header class="header">
                <div class="logo">
                    <div class="logo-icon">ðŸ§ </div>
                    <h1>StudyMaster AI</h1>
                </div>
                <div class="header-actions">
                    <div class="streak-badge">
                        <span>ðŸ”¥</span>
                        <span class="streak-number" id="streakCounter">0 day streak</span>
                    </div>
                    <div class="user-info">
                        <span>Welcome back!</span>
                    </div>
                    <button class="theme-toggle" onclick="toggleTheme()">
                        <i class="fa-solid fa-moon"></i>
                    </button>
                    <button class="btn" onclick="logout()">Logout</button>
                </div>
            </header>

            <div class="main-layout">
                <aside class="left-sidebar">
                    <div class="card">
                        <div class="upload-area" id="uploadArea">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">ðŸ“¤</div>
                            <p><strong>Drop files here</strong></p>
                            <p style="font-size: 0.85rem; opacity: 0.7;">PDF, TXT, DOC, DOCX</p>
                            <input type="file" id="fileInput" multiple accept=".pdf,.txt,.doc,.docx">
                        </div>
                        <div class="file-list" id="fileList"></div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ðŸŽ¯ Study Mode</h3>
                        </div>
                        <div class="study-modes">
                            <button class="mode-btn active" data-mode="comprehensive">
                                <div>ðŸ¤–</div>
                                <div>Comprehensive</div>
                            </button>
                            <button class="mode-btn" data-mode="summary">
                                <div>ðŸ“‹</div>
                                <div>Summary</div>
                            </button>
                            <button class="mode-btn" data-mode="flashcards">
                                <div>ðŸ”„</div>
                                <div>Flashcards</div>
                            </button>
                            <button class="mode-btn" data-mode="practice">
                                <div>âœï¸</div>
                                <div>Practice</div>
                            </button>
                        </div>
                    </div>

                    <button class="btn-primary" id="processBtn" disabled>
                        ðŸš€ Generate Study Materials
                    </button>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ðŸ“Š Progress</h3>
                        </div>
                        <div class="progress-ring">
                            <svg width="120" height="120">
                                <circle class="bg" cx="60" cy="60" r="54"></circle>
                                <circle class="progress" cx="60" cy="60" r="54" id="progressCircle"></circle>
                            </svg>
                        </div>
                        <div class="progress-text" id="progressText">0%</div>
                    </div>
                </aside>

                <main class="main-content">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="totalStudyTime">0h</div>
                            <div class="stat-label">Study Time</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="cardsReviewed">0</div>
                            <div class="stat-label">Cards Reviewed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="accuracy">0%</div>
                            <div class="stat-label">Accuracy</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="mastery">0%</div>
                            <div class="stat-label">Mastery</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="content-tabs">
                            <button class="tab active" data-tab="ai-tutor">AI Tutor</button>
                            <button class="tab" data-tab="summary">Summary</button>
                            <button class="tab" data-tab="flashcards">Flashcards</button>
                            <button class="tab" data-tab="practice">Practice</button>
                        </div>

                        <div class="tab-content active" id="ai-tutorContent">
                            <div class="chat-container">
                                <div class="chat-messages" id="chatMessages">
                                    <div class="message ai">
                                        <p>Hello! I'm your AI study assistant. Upload some study materials and I'll help you learn more effectively!</p>
                                    </div>
                                </div>
                                <div class="chat-input-container">
                                    <input type="text" class="chat-input" id="chatInput" placeholder="Ask me anything about your study materials...">
                                    <button class="send-btn" id="sendBtn">Send</button>
                                </div>
                            </div>
                        </div>

                        <div class="tab-content" id="summaryContent">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p>Upload files to generate study materials...</p>
                            </div>
                        </div>

                        <div class="tab-content" id="flashcardsContent">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p>Upload files to generate flashcards...</p>
                            </div>
                            <div id="flashcards-container" class="flashcard-container"></div>
                        </div>

                        <div class="tab-content" id="practiceContent">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p>Upload files to generate practice questions...</p>
                            </div>
                        </div>
                    </div>
                </main>

                <aside class="right-sidebar">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ðŸŽ¯ Study Plan</h3>
                        </div>
                        <div class="study-plan">
                            <div class="study-plan-item">
                                <div class="study-plan-check" onclick="toggleCheck(this)"></div>
                                <span>Review uploaded materials</span>
                            </div>
                            <div class="study-plan-item">
                                <div class="study-plan-check" onclick="toggleCheck(this)"></div>
                                <span>Complete practice questions</span>
                            </div>
                            <div class="study-plan-item">
                                <div class="study-plan-check" onclick="toggleCheck(this)"></div>
                                <span>Review flashcards</span>
                            </div>
                            <div class="study-plan-item">
                                <div class="study-plan-check" onclick="toggleCheck(this)"></div>
                                <span>Take practice quiz</span>
                            </div>
                            <div class="study-plan-item">
                                <div class="study-plan-check" onclick="toggleCheck(this)"></div>
                                <span>Review weak areas</span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ðŸ“ˆ Study Stats</h3>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value">5</div>
                                <div class="stat-label">Files Uploaded</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">12</div>
                                <div class="stat-label">Sessions</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">85%</div>
                                <div class="stat-label">Avg Score</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">3.2h</div>
                                <div class="stat-label">This Week</div>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div class="modal" id="authModal" style="display: none;">
        <div class="modal-content">
            <button class="close-btn" onclick="closeAuthModal()">Ã—</button>
            <div class="modal-header">
                <h2 class="modal-title" id="authTitle">Welcome Back</h2>
                <p>Sign in to continue your learning journey</p>
            </div>
            <form id="authForm">
                <div class="form-group" id="nameGroup" style="display: none;">
                    <label for="name">Full Name</label>
                    <input type="text" id="name" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn-primary">Sign In</button>
            </form>
            <div class="auth-toggle">
                <p>Don't have an account? <a onclick="toggleAuthMode()">Sign up here</a></p>
            </div>
            <div class="error-message" id="authError" style="display: none;"></div>
        </div>
    </div>

    <script>
        // StudyMaster AI - Integrated API Client and Application
        class StudyMasterAPI {
            constructor() {
                // Detect backend URL based on current environment
                this.baseURL = this.detectBackendURL();
                this.token = this.getStoredToken();
                this.userId = localStorage.getItem('userId');

                console.log('ðŸš€ StudyMaster API initialized');
                console.log('ðŸ“¡ Backend URL:', this.baseURL);
                console.log('ðŸ” Has Token:', !!this.token);

                this.updateConnectionStatus('connecting');
                this.testConnection();
            }

            detectBackendURL() {
                const hostname = window.location.hostname;

                if (hostname === 'localhost' || hostname === '127.0.0.1') {
                    return 'http://localhost:3000';
                } else if (hostname.includes('replit.dev') || hostname.includes('janeway')) {
                    // For Replit, backend and frontend share same domain, different ports internally
                    // But external access should use the main domain without port specification
                    const protocol = window.location.protocol;
                    const baseUrl = `${protocol}//${hostname}`;
                    // Try main domain first (Replit's proxy routing)
                    return baseUrl;
                } else {
                    // Default fallback for other environments
                    return window.location.protocol + '//' + window.location.hostname + ':3000';
                }
            }

            getStoredToken() {
                return localStorage.getItem('auth_token') || localStorage.getItem('token');
            }

            async testConnection() {
                try {
                    console.log('ðŸ”„ Testing connection to:', `${this.baseURL}/health`);
                    const response = await fetch(`${this.baseURL}/health`);
                    if (response.ok) {
                        const data = await response.json();
                        console.log('âœ… Backend connected:', data);
                        this.updateConnectionStatus('connected');
                        return true;
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.error('âŒ Backend connection failed:', error);
                    console.log('ðŸ”„ Trying alternative connection...');
                    
                    // Try the test endpoint as fallback
                    try {
                        const testResponse = await fetch(`${this.baseURL}/test-connection`);
                        if (testResponse.ok) {
                            const testData = await testResponse.json();
                            console.log('âœ… Alternative connection successful:', testData);
                            this.updateConnectionStatus('connected');
                            return true;
                        }
                    } catch (testError) {
                        console.error('âŒ Alternative connection also failed:', testError);
                    }
                    
                    this.updateConnectionStatus('disconnected');
                    return false;
                }
            }

            updateConnectionStatus(status) {
                const statusElement = document.getElementById('connectionStatus');
                if (statusElement) {
                    statusElement.className = `connection-status ${status}`;
                    switch(status) {
                        case 'connected':
                            statusElement.textContent = 'ðŸŸ¢ Connected';
                            break;
                        case 'connecting':
                            statusElement.textContent = 'ðŸŸ¡ Connecting...';
                            break;
                        case 'disconnected':
                            statusElement.textContent = 'ðŸ”´ Disconnected';
                            break;
                    }
                }
            }

            getHeaders() {
                return {
                    'Content-Type': 'application/json',
                    'Authorization': this.token ? `Bearer ${this.token}` : ''
                };
            }

            async makeRequest(endpoint, options = {}) {
                const urlsToTry = [
                    this.baseURL, // Primary URL (main domain)
                    window.location.protocol + '//' + window.location.hostname + ':3000', // Direct port access
                    'https://' + window.location.hostname.replace('-00-', '-00-') + ':3000' // Alternative format
                ];

                for (let i = 0; i < urlsToTry.length; i++) {
                    const currentURL = urlsToTry[i];
                    try {
                        console.log(`ðŸ”„ Attempting request to: ${currentURL}${endpoint}`);
                        
                        const response = await fetch(`${currentURL}${endpoint}`, {
                            ...options,
                            mode: 'cors',
                            credentials: 'omit',
                            headers: {
                                ...this.getHeaders(),
                                ...options.headers
                            }
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({ 
                                error: `HTTP ${response.status}: ${response.statusText}` 
                            }));
                            throw new Error(errorData.error || `HTTP ${response.status}`);
                        }

                        // Success! Update base URL if we found a working one
                        if (currentURL !== this.baseURL) {
                            console.log(`âœ… Found working backend URL: ${currentURL}`);
                            this.baseURL = currentURL;
                        }
                        this.updateConnectionStatus('connected');
                        return { success: true, data: await response.json() };

                    } catch (error) {
                        console.error(`âŒ Request failed for ${currentURL}${endpoint}:`, error.message);
                        
                        // If this was the last URL to try, return the error
                        if (i === urlsToTry.length - 1) {
                            console.error(`âŒ All backend URLs failed for ${endpoint}`);
                            this.updateConnectionStatus('disconnected');
                            return { success: false, error: error.message };
                        }
                        // Otherwise, continue to next URL
                    }
                }
            }

            async register(email, password, name) {
                const result = await this.makeRequest('/api/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({ email, password, name })
                });

                if (result.success && result.data.token) {
                    this.token = result.data.token;
                    this.userId = result.data.user.id;
                    localStorage.setItem('auth_token', result.data.token);
                    localStorage.setItem('userId', result.data.user.id);
                }

                return result;
            }

            async login(email, password) {
                const result = await this.makeRequest('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                if (result.success && result.data.token) {
                    this.token = result.data.token;
                    this.userId = result.data.user.id;
                    localStorage.setItem('auth_token', result.data.token);
                    localStorage.setItem('userId', result.data.user.id);
                }

                return result;
            }

            async uploadFiles(files) {
                if (!this.token) {
                    return { success: false, error: 'Please login first' };
                }

                try {
                    const formData = new FormData();
                    Array.from(files).forEach(file => {
                        formData.append('files', file);
                    });

                    const response = await fetch(`${this.baseURL}/api/upload`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.token}`
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ 
                            error: `Upload failed: HTTP ${response.status}` 
                        }));
                        throw new Error(errorData.error);
                    }

                    const data = await response.json();
                    return { success: true, data };

                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            async generateContent(fileIds, mode = 'comprehensive') {
                // Use 'gpt-3.5-turbo' for better quality content generation
                return await this.makeRequest('/api/generate', {
                    method: 'POST',
                    body: JSON.stringify({ fileIds, mode, model: 'gpt-3.5-turbo' })
                });
            }

            async generateAdaptivePractice(weakAreas, difficulty, topic, previousAnswers) {
                return await this.makeRequest('/api/adaptive-practice', {
                    method: 'POST',
                    body: JSON.stringify({ weakAreas, difficulty, topic, previousAnswers })
                });
            }

            async sendChatMessage(message, sessionId) {
                return await this.makeRequest('/api/chat', {
                    method: 'POST',
                    body: JSON.stringify({ message, sessionId })
                });
            }

            async getStats() {
                if (!this.token) {
                    return {
                        success: true,
                        data: {
                            totalStudyTime: 0,
                            cardsReviewed: 0,
                            accuracy: 0,
                            mastery: 0,
                            streak: 0
                        }
                    };
                }

                try {
                    const userId = this.userId || 'demo';
                    const response = await this.makeRequest(`/api/stats/${userId}`);

                    if (!response.success) {
                        console.warn('Stats API failed, using demo data:', response.error);
                        // Return demo stats if API fails
                        return {
                            success: true,
                            data: {
                                totalStudyTime: 5,
                                cardsReviewed: 12,
                                accuracy: 85,
                                mastery: 72,
                                streak: 3
                            }
                        };
                    }

                    return response;
                } catch (error) {
                    console.warn('Stats request failed, using demo data:', error);
                    return {
                        success: true,
                        data: {
                            totalStudyTime: 5,
                            cardsReviewed: 12,
                            accuracy: 85,
                            mastery: 72,
                            streak: 3
                        }
                    };
                }
            }

            logout() {
                this.token = null;
                this.userId = null;
                localStorage.removeItem('auth_token');
                localStorage.removeItem('token');
                localStorage.removeItem('userId');
            }

            isAuthenticated() {
                return !!this.token;
            }
        }

        // Application State
        let api;
        let uploadedFiles = [];
        let currentMode = 'comprehensive';
        let currentSession = null;
        let isLoggedIn = false;
        let userPerformanceData = {
            incorrectAnswers: [],
            weakAreas: [],
            difficulty: 'Medium',
            topic: 'General'
        };

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            api = new StudyMasterAPI();
            window.api = api; // For debugging

            initializeApp();
            setupEventListeners();
        });

        function initializeApp() {
            const token = localStorage.getItem('auth_token') || localStorage.getItem('token');

            if (token) {
                isLoggedIn = true;
                showDashboard();
                loadUserStats();
            } else {
                showLanding();
            }
        }

        function showLanding() {
            document.getElementById('landingPage').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }

        function startFreeTrial() {
            showRegister();
        }

        function showLogin() {
            document.getElementById('authTitle').textContent = 'Welcome Back';
            document.getElementById('nameGroup').style.display = 'none';
            document.querySelector('#authForm button').textContent = 'Sign In';
            document.querySelector('.auth-toggle p').innerHTML = 'Don\'t have an account? <a onclick="toggleAuthMode()">Sign up here</a>';
            document.getElementById('authModal').style.display = 'flex';
        }

        function showRegister() {
            document.getElementById('authTitle').textContent = 'Create Account';
            document.getElementById('nameGroup').style.display = 'block';
            document.querySelector('#authForm button').textContent = 'Create Account';
            document.querySelector('.auth-toggle p').innerHTML = 'Already have an account? <a onclick="toggleAuthMode()">Sign in here</a>';
            document.getElementById('authModal').style.display = 'flex';
        }

        function toggleAuthMode() {
            const title = document.getElementById('authTitle');
            const nameGroup = document.getElementById('nameGroup');
            const submitBtn = document.querySelector('#authForm button');
            const toggleText = document.querySelector('.auth-toggle p');

            if (title.textContent === 'Welcome Back') {
                title.textContent = 'Create Account';
                nameGroup.style.display = 'block';
                submitBtn.textContent = 'Create Account';
                toggleText.innerHTML = 'Already have an account? <a onclick="toggleAuthMode()">Sign in here</a>';
            } else {
                title.textContent = 'Welcome Back';
                nameGroup.style.display = 'none';
                submitBtn.textContent = 'Sign In';
                toggleText.innerHTML = 'Don\'t have an account? <a onclick="toggleAuthMode()">Sign up here</a>';
            }
        }

        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            clearAuthForm();
        }

        function clearAuthForm() {
            document.getElementById('authForm').reset();
            document.getElementById('authError').style.display = 'none';
        }

        async function handleAuth(e) {
            e.preventDefault();

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const name = document.getElementById('name').value.trim();
            const isLogin = document.getElementById('authTitle').textContent === 'Welcome Back';

            if (!email || !password || (!isLogin && !name)) {
                showAuthError('Please fill in all required fields');
                return;
            }

            const submitBtn = document.querySelector('#authForm button');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Please wait...';
            submitBtn.disabled = true;

            try {
                let result;

                if (isLogin) {
                    result = await api.login(email, password);
                } else {
                    result = await api.register(email, password, name);
                }

                if (result.success) {
                    isLoggedIn = true;
                    closeAuthModal();
                    showDashboard();
                    loadUserStats();
                    showToast(`Welcome ${isLogin ? 'back' : 'to StudyMaster'}!`, 'success');
                } else {
                    showAuthError(result.error || 'Authentication failed');
                }

            } catch (error) {
                showAuthError('Connection error. Please try again.');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        function showAuthError(message) {
            const errorElement = document.getElementById('authError');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        function logout() {
            api.logout();
            isLoggedIn = false;
            uploadedFiles = [];
            currentSession = null;
            showLanding();
            showToast('Logged out successfully', 'success');
        }

        async function loadUserStats() {
            if (api.isAuthenticated()) {
                try {
                    const result = await api.getStats();
                    if (result.success) {
                        updateStatsDisplay(result.data);
                    } else {
                        console.warn('Stats loading failed:', result.error);
                        // Use fallback stats on failure
                        updateStatsDisplay({
                            totalStudyTime: 5,
                            cardsReviewed: 12,
                            accuracy: 85,
                            mastery: 72
                        });
                    }
                } catch (error) {
                    console.error('Stats loading error:', error);
                    updateStatsDisplay({
                        totalStudyTime: 5,
                        cardsReviewed: 12,
                        accuracy: 85,
                        mastery: 72
                    });
                }
            }
        }

        function updateStatsDisplay(stats) {
            // Add null checks and error handling
            try {
                const studyTimeEl = document.getElementById('totalStudyTime');
                const cardsReviewedEl = document.getElementById('cardsReviewed');
                const accuracyEl = document.getElementById('accuracy');
                const masteryEl = document.getElementById('mastery');

                if (studyTimeEl) studyTimeEl.textContent = `${stats.totalStudyTime || 0}h`;
                if (cardsReviewedEl) cardsReviewedEl.textContent = stats.cardsReviewed || 0;
                if (accuracyEl) accuracyEl.textContent = `${stats.accuracy || 0}%`;
                if (masteryEl) masteryEl.textContent = `${stats.mastery || 0}%`;
            } catch (error) {
                console.error('Error updating stats display:', error);
            }
        }

        function setupEventListeners() {
            // File upload
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            if (uploadArea && fileInput) {
                uploadArea.addEventListener('click', () => fileInput.click());
                uploadArea.addEventListener('dragover', handleDragOver);
                uploadArea.addEventListener('dragleave', handleDragLeave);
                uploadArea.addEventListener('drop', handleDrop);
                fileInput.addEventListener('change', handleFileSelect);
            }

            // Auth form
            const authForm = document.getElementById('authForm');
            if (authForm) {
                authForm.addEventListener('submit', handleAuth);
            }

            // Process button
            const processBtn = document.getElementById('processBtn');
            if (processBtn) {
                processBtn.addEventListener('click', processFiles);
            }

            // Study modes
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => selectMode(btn));
            });

            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab));
            });

            // Chat
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');

            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') sendMessage();
                });
            }
            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }

            // Modal close on outside click
            document.getElementById('authModal')?.addEventListener('click', (e) => {
                if (e.target.id === 'authModal') closeAuthModal();
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            addFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            addFiles(files);
        }

        function addFiles(files) {
            if (!isLoggedIn) {
                showToast('Please login to upload files', 'error');
                showLogin();
                return;
            }

            files.forEach(file => {
                if (!uploadedFiles.find(f => f.name === file.name)) {
                    uploadedFiles.push({
                        file: file,
                        name: file.name,
                        size: file.size,
                        type: file.type
                    });
                }
            });
            updateFileList();
            updateProcessButton();
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileList();
            updateProcessButton();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            if (!fileList) return;

            fileList.innerHTML = uploadedFiles.map((fileObj, index) => `
                <div class="file-item">
                    <div class="file-name">
                        <span><i class="fa-solid fa-file-lines"></i></span>
                        <span>${fileObj.name}</span>
                    </div>
                    <span class="file-size">${formatFileSize(fileObj.size)}</span>
                    <button class="remove-btn" onclick="removeFile(${index})">Remove</button>
                </div>
            `).join('');
        }

        function updateProcessButton() {
            const processBtn = document.getElementById('processBtn');
            if (processBtn) {
                processBtn.disabled = uploadedFiles.length === 0;
            }
        }

        function selectMode(btn) {
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentMode = btn.dataset.mode;
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            tab.classList.add('active');
            const contentId = tab.dataset.tab + 'Content';
            const content = document.getElementById(contentId);
            if (content) {
                content.classList.add('active');
                console.log(`ðŸ”„ Switched to tab: ${tab.dataset.tab}`);
            } else {
                console.error(`âŒ Content element not found: ${contentId}`);
            }
        }

        let currentFileIds = []; // Variable to store uploaded file IDs

        async function processFiles() {
            if (uploadedFiles.length === 0 || !isLoggedIn) {
                showToast('Please login and upload files first', 'error');
                return;
            }

            const processBtn = document.getElementById('processBtn');
            processBtn.textContent = 'â³ Processing...';
            processBtn.disabled = true;

            try {
                // Upload files
                const realFiles = uploadedFiles.map(f => f.file);
                const uploadResult = await api.uploadFiles(realFiles);

                if (!uploadResult.success) {
                    const errorMsg = uploadResult.error || 'Upload failed';
                    throw new Error(errorMsg);
                }

                // Store file IDs for potential retry
                currentFileIds = uploadResult.data.files.map(f => f.id);

                // Generate content
                const generateResult = await api.generateContent(currentFileIds, currentMode);

                if (!generateResult.success) {
                    const errorMsg = generateResult.error || 'Content generation failed';
                    throw new Error(errorMsg);
                }

                currentSession = generateResult.data.sessionId;
                displayGeneratedContent(generateResult.data.content);
                showToast('Study materials generated successfully!', 'success');

            } catch (error) {
                console.error('Processing error details:', {
                    message: error.message,
                    stack: error.stack,
                    error: error
                });
                // More specific error handling
                let errorMessage = 'Processing failed';
                if (error.message) {
                    errorMessage = error.message;
                } else if (typeof error === 'string') {
                    errorMessage = error;
                } else {
                    errorMessage = 'Unknown error occurred during processing';
                }
                showToast(errorMessage, 'error');
            } finally {
                processBtn.textContent = 'ðŸš€ Generate Study Materials';
                processBtn.disabled = false;
            }
        }

        function displayGeneratedContent(content) {
            if (content.summary) {
                const summaryContainer = document.getElementById('summaryContent');
                // Handle enhanced summary format
                if (typeof content.summary === 'string') {
                    summaryContainer.innerHTML = content.summary;
                } else if (typeof content.summary === 'object') {
                    let summaryHTML = `
                        <div class="enhanced-summary">
                            ${content.summary.overview ? `
                                <div class="summary-section">
                                    <h3>ðŸ“š Overview</h3>
                                    <p class="overview-text">${content.summary.overview}</p>
                                </div>
                            ` : ''}

                            <div class="summary-meta">
                                ${content.summary.difficultyLevel ? `
                                    <div class="meta-item">
                                        <span class="meta-label">Difficulty:</span>
                                        <span class="difficulty-badge ${content.summary.difficultyLevel.toLowerCase()}">${content.summary.difficultyLevel}</span>
                                    </div>
                                ` : ''}
                                ${content.summary.estimatedStudyTime ? `
                                    <div class="meta-item">
                                        <span class="meta-label">â±ï¸ Study Time:</span>
                                        <span class="time-estimate">${content.summary.estimatedStudyTime}</span>
                                    </div>
                                ` : ''}
                            </div>

                            ${content.summary.learningObjectives && Array.isArray(content.summary.learningObjectives) ? `
                                <div class="summary-section">
                                    <h4>ðŸŽ¯ Learning Objectives</h4>
                                    <ul class="objectives-list">
                                        ${content.summary.learningObjectives.map(obj => `<li>${obj}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}

                            ${content.summary.keyPoints && Array.isArray(content.summary.keyPoints) ? `
                                <div class="summary-section">
                                    <h4>ðŸ’¡ Key Points</h4>
                                    <ul class="key-points-list">
                                        ${content.summary.keyPoints.map(point => `<li>${point}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}

                            ${content.summary.criticalConcepts && Array.isArray(content.summary.criticalConcepts) ? `
                                <div class="summary-section">
                                    <h4>ðŸ” Critical Concepts</h4>
                                    <div class="concepts-grid">
                                        ${content.summary.criticalConcepts.map(concept => `
                                            <div class="concept-card">
                                                <h5>${concept.concept}</h5>
                                                <p>${concept.explanation}</p>
                                                <div class="concept-meta">
                                                    <span class="importance-badge ${concept.importance?.toLowerCase()}">${concept.importance}</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${content.summary.studyStrategy ? `
                                <div class="summary-section">
                                    <h4>ðŸ“– Study Strategy</h4>
                                    <div class="strategy-content">
                                        <p><strong>Approach:</strong> ${content.summary.studyStrategy.approach}</p>
                                        ${content.summary.studyStrategy.focusAreas ? `
                                            <div><strong>Focus Areas:</strong> ${content.summary.studyStrategy.focusAreas.join(', ')}</div>
                                        ` : ''}
                                        ${content.summary.studyStrategy.commonMistakes ? `
                                            <div><strong>âš ï¸ Common Mistakes:</strong></div>
                                            <ul class="mistakes-list">
                                                ${content.summary.studyStrategy.commonMistakes.map(mistake => `<li>${mistake}</li>`).join('')}
                                            </ul>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    summaryContainer.innerHTML = summaryHTML;
                }
            }

            if (content.flashcards) {
                displayFlashcards(content.flashcards);
            }

            if (content.questions) {
                displayQuestions(content.questions);
            }

            if (content.studyPlan) {
                displayStudyPlan(content.studyPlan);
            }

            // Switch to summary tab if flashcards or questions were generated
            if (content.flashcards || content.questions) {
                const activeTab = document.querySelector('.tab.active');
                if (activeTab && activeTab.dataset.tab !== 'ai-tutor') {
                    // Already on a content tab, no need to switch unless it's AI tutor
                } else {
                    const summaryTab = document.querySelector('[data-tab="summary"]');
                    if (summaryTab) {
                        summaryTab.click();
                    }
                }
            }
        }

        function displayFlashcards(flashcardsData) {
            const container = document.getElementById('flashcardsContent');

            // Clear existing content, including the retry button if it exists
            if (container) {
                container.innerHTML = '';
            } else {
                console.error('âŒ Flashcard container not found.');
                return;
            }

            let flashcards = [];

            // Handle different flashcard data structures
            if (Array.isArray(flashcardsData)) {
                flashcards = flashcardsData;
            } else if (flashcardsData && flashcardsData.flashcards) {
                flashcards = flashcardsData.flashcards;
            } else if (flashcardsData && Array.isArray(flashcardsData.flashcards)) {
                flashcards = flashcardsData.flashcards;
            } else {
                console.error('âŒ Invalid flashcard data structure:', flashcardsData);
                container.innerHTML = '<div class="loading"><p>No flashcards available. Please upload study materials first.</p></div>';
                return;
            }

            console.log(`ðŸ“Š Processing ${flashcards.length} flashcards`);

            // Add Study More button for additional flashcards
            const studyMoreBtn = document.createElement('div');
            studyMoreBtn.className = 'study-more-btn';
            studyMoreBtn.innerHTML = `
                <div style="text-align: center; margin: 2rem 0; padding: 2rem; background: rgba(99, 102, 241, 0.1); border-radius: 12px; border: 1px solid var(--primary);">
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">Want to study more?</h3>
                    <p style="color: #94a3b8; margin-bottom: 1.5rem;">Generate additional flashcards to deepen your understanding</p>
                    <button id="study-more-flashcards" onclick="generateMoreFlashcards()" style="
                        background: linear-gradient(135deg, var(--primary), var(--secondary)); 
                        color: white; 
                        border: none; 
                        padding: 1rem 2rem; 
                        border-radius: 10px; 
                        cursor: pointer; 
                        font-size: 1.1rem;
                        font-weight: bold;
                        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
                        transition: all 0.3s ease;
                    ">
                        ðŸ“š Study More (+6 cards)
                    </button>
                </div>
            `;
            container.appendChild(studyMoreBtn);

            if (flashcards.length === 0) {
                container.innerHTML = '<p>No flashcards generated. Please try uploading different content.</p>';
                return;
            }

            // Generate flashcard HTML with proper error handling
            const flashcardHTML = flashcards.map((card, index) => {
                // Ensure card has required properties with fallbacks
                const term = card.term || card.front || card.question || 'Concept';
                const definition = card.definition || card.back || card.answer || 'Definition not available';
                const difficulty = card.difficulty || 3;
                const importance = card.importance || 3;
                const category = card.category || 'General';

                // Check if this is a simple flashcard (only term/definition) or complex one
                const isSimpleCard = !card.multipleExamples && !card.connections && !card.commonMisconceptions && !card.visualDescription && !card.mnemonic;

                return `
                    <div class="flashcard ${isSimpleCard ? 'simple-card' : 'complex-card'}" data-card-id="${index}" data-difficulty="${difficulty}" data-importance="${importance}">
                        <div class="flashcard-header">
                            <div class="card-meta">
                                <span class="difficulty-indicator">Level ${difficulty}</span>
                                <span class="category-tag">${category}</span>
                                <span class="importance-stars">${'â˜…'.repeat(Math.min(importance, 5))}</span>
                            </div>
                        </div>
                        <div class="flashcard-inner">
                            <div class="flashcard-front">
                                <div class="card-content" style="display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; min-height: ${isSimpleCard ? '200px' : '300px'};">
                                    <h3 style="margin-bottom: 1.5rem; color: white; font-size: ${isSimpleCard ? '1.5rem' : '1.3rem'}; font-weight: bold; padding: 0 1rem; word-wrap: break-word; overflow-wrap: break-word; max-width: 100%;">${term}</h3>
                                    ${!isSimpleCard ? `
                                        ${card.memoryTips ? `<div class="memory-tip" style="margin: 0.5rem 0; padding: 0.75rem; background: rgba(99, 102, 241, 0.1); border-radius: 8px; border-left: 3px solid #6366f1;">ðŸ’¡ <strong>Memory Tip:</strong> ${card.memoryTips}</div>` : ''}
                                        ${card.visualDescription ? `<div class="visual-tip" style="margin: 0.5rem 0; padding: 0.75rem; background: rgba(168, 85, 247, 0.1); border-radius: 8px; border-left: 3px solid #a855f7;">ðŸ–¼ï¸ <strong>Visualize:</strong> ${card.visualDescription}</div>` : ''}
                                        ${card.mnemonic ? `<div class="mnemonic-tip" style="margin: 0.5rem 0; padding: 0.75rem; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border-left: 3px solid #22c55e;">ðŸ§  <strong>Remember:</strong> ${card.mnemonic}</div>` : ''}
                                    ` : ''}
                                </div>
                                <div class="card-actions">
                                    <button class="flip-btn" onclick="flipCard(${index})" style="padding: 1rem 2rem; font-size: 1.1rem; font-weight: bold;">Show Answer</button>
                                </div>
                            </div>
                            <div class="flashcard-back">
                                <div class="card-content" style="display: flex; flex-direction: column; justify-content: flex-start; min-height: ${isSimpleCard ? '200px' : '300px'};">
                                    <div class="definition" style="margin-bottom: 1.5rem; line-height: 1.6; font-size: ${isSimpleCard ? '1.1rem' : '1rem'}; text-align: ${isSimpleCard ? 'center' : 'left'}; ${isSimpleCard ? 'display: flex; align-items: center; justify-content: center; flex-grow: 1;' : ''}">${definition}</div>

                                    ${!isSimpleCard ? `
                                        ${card.multipleExamples && Array.isArray(card.multipleExamples) && card.multipleExamples.length > 0 ? `
                                            <div class="examples" style="background: rgba(34, 197, 94, 0.1); padding: 1rem; border-radius: 8px; border-left: 3px solid #22c55e; margin: 0.5rem 0;">
                                                <strong style="color: #4ade80;">ðŸ“ Examples:</strong>
                                                <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">${card.multipleExamples.map(ex => `<li style="margin: 0.3rem 0; color: #a7f3d0;">${ex}</li>`).join('')}</ul>
                                            </div>
                                        ` : ''}

                                        ${card.connections && Array.isArray(card.connections) && card.connections.length > 0 ? `
                                            <div class="connections" style="background: rgba(6, 182, 212, 0.1); padding: 1rem; border-radius: 8px; margin: 0.5rem 0; border-left: 3px solid #06b6d4;">
                                                <strong style="color: #22d3ee;">ðŸ”— Connections:</strong>
                                                <div class="connection-tags" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                                                    ${card.connections.map(conn => `<span class="connection-tag" style="background: rgba(6, 182, 212, 0.2); border: 1px solid #06b6d4; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; color: #67e8f9;">${conn}</span>`).join('')}
                                                </div>
                                            </div>
                                        ` : ''}

                                        ${card.commonMisconceptions && Array.isArray(card.commonMisconceptions) && card.commonMisconceptions.length > 0 ? `
                                            <div class="misconceptions" style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 8px; margin: 0.5rem 0; border-left: 3px solid #ef4444;">
                                                <strong style="color: #f87171;">âš ï¸ Common Misconceptions:</strong>
                                                <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">${card.commonMisconceptions.map(misc => `<li style="margin: 0.3rem 0; color: #fecaca;">${misc}</li>`).join('')}</ul>
                                            </div>
                                        ` : ''}

                                        ${card.practiceQuestion ? `
                                            <div class="practice-question" style="background: rgba(168, 85, 247, 0.1); padding: 0.75rem; border-radius: 8px; margin: 0.5rem 0; border-left: 3px solid #a855f7;">
                                                <strong style="color: #c4b5fd;">ðŸ¤” Test Yourself:</strong>
                                                <div class="practice-q" style="margin-top: 0.5rem; font-style: italic; color: #e9d5ff;">${card.practiceQuestion}</div>
                                            </div>
                                        ` : ''}
                                    ` : ''}
                                </div>
                                <div class="card-actions">
                                    <button class="feedback-btn easy" onclick="markCardWithSpacing(${index}, 'easy')" style="padding: ${isSimpleCard ? '0.75rem 1.5rem' : '0.5rem 1rem'};">ðŸ˜Š Easy</button>
                                    <button class="feedback-btn medium" onclick="markCardWithSpacing(${index}, 'medium')" style="padding: ${isSimpleCard ? '0.75rem 1.5rem' : '0.5rem 1rem'};">ðŸ˜ Medium</button>
                                    <button class="feedback-btn hard" onclick="markCardWithSpacing(${index}, 'hard')" style="padding: ${isSimpleCard ? '0.75rem 1.5rem' : '0.5rem 1rem'};">ðŸ˜“ Hard</button>
                                    <button class="flip-btn" onclick="flipCard(${index})" style="padding: ${isSimpleCard ? '0.75rem 1.5rem' : '0.5rem 1rem'};">Back to Question</button>
                                </div>
                            </div>
                        </div>
                        <div class="card-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${getCardProgress(index)}%"></div>
                            </div>
                            <span class="next-review">Next review: ${getNextReviewTime(index)}</span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = flashcardHTML;
            // Initialize spaced repetition data
            initializeSpacedRepetition(flashcards);
            console.log('âœ… Flashcards displayed successfully');
        }

        function displayQuestions(questions) {
            const container = document.getElementById('practiceContent');
            console.log('â“ Displaying questions:', questions);

            // Handle different question structures - support both old format and new multi-set format
            if (questions && (questions.set1 || questions.set2 || questions.set3)) {
                // New multi-set format like Cengage
                displayMultiSetQuestions(questions, container);
                return;
            }

            let questionArray = questions;
            if (questions && questions.multipleChoice) {
                questionArray = questions.multipleChoice;
            } else if (questions && questions.questions) {
                questionArray = questions.questions;
            }

            if (Array.isArray(questionArray)) {
                container.innerHTML = questionArray.map((q, index) => `
                    <div class="question-container" data-question-id="${index}" style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem;">
                        <h4>Question ${index + 1}</h4>
                        <div style="margin: 1rem 0; font-size: 1.1rem;">${q.question}</div>
                        ${q.options ? `
                            <div class="question-options" style="margin: 1rem 0;">
                                ${q.options.map((option, i) => `
                                    <label class="option-label" style="display: block; margin: 0.5rem 0; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                                        <input type="radio" name="question${index}" value="${i}" data-option="${option}" style="margin-right: 0.5rem;">
                                        ${option}
                                    </label>
                                `).join('')}
                            </div>
                            <div class="question-actions" style="margin: 1rem 0;">
                                <button onclick="checkAnswer(${index}, '${q.correctAnswer}', '${q.explanation || 'Good job!'}')" class="check-btn" style="padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; margin-right: 0.5rem;">Check Answer</button>
                                <button onclick="showHint(${index})" class="hint-btn" style="padding: 0.75rem 1.5rem; background: rgba(255,255,255,0.1); color: white; border: 1px solid var(--glass-border); border-radius: 8px; cursor: pointer;">Show Hint</button>
                            </div>
                            <div class="question-feedback" id="feedback${index}" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none;"></div>
                        ` : `
                            <div style="margin-top: 1rem;">
                                <textarea id="textAnswer${index}" placeholder="Type your answer here..." style="width: 100%; height: 100px; padding: 0.75rem; border: 1px solid var(--glass-border); border-radius: 8px; background: rgba(255, 255, 255, 0.05); color: white; resize: vertical;"></textarea>
                                <div style="margin-top: 0.5rem;">
                                    <button onclick="submitTextAnswer(${index})" class="check-btn" style="padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">Submit Answer</button>
                                </div>
                                <div class="question-feedback" id="feedback${index}" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none;"></div>
                            </div>
                        `}
                    </div>
                `).join('');

                // Store questions data for checking
                window.currentQuestions = questionArray;
            } else {
                console.error('âŒ Questions data is not an array:', questions);
                container.innerHTML = '<p>No practice questions available or invalid format.</p>';
            }
        }

        function displayMultiSetQuestions(questionSets, container) {
            console.log('ðŸ“š Displaying multi-set questions like Cengage:', questionSets);

            let setsHTML = '';
            let setNumber = 1;

            // Process each question set (set1, set2, set3)
            ['set1', 'set2', 'set3'].forEach(setKey => {
                if (questionSets[setKey]) {
                    const set = questionSets[setKey];
                    setsHTML += `
                        <div class="question-set" data-set="${setKey}" style="margin-bottom: 2rem;">
                            <div class="set-header" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(6, 182, 212, 0.2)); padding: 1rem; border-radius: 12px 12px 0 0; border-left: 4px solid var(--primary);">
                                <h3 style="margin: 0; color: white;">ðŸ“– ${set.title || `Question Set ${setNumber}`}</h3>
                                <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.9rem; opacity: 0.9;">
                                    <span>ðŸŽ¯ Difficulty: ${set.difficulty || 'Medium'}</span>
                                    <span>ðŸ“Š ${getTotalQuestionsInSet(set)} questions</span>
                                </div>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.8;">${set.description || ''}</p>
                            </div>
                            <div class="set-content" style="background: rgba(255, 255, 255, 0.02); padding: 1rem; border-radius: 0 0 12px 12px; border: 1px solid var(--glass-border);">
                                ${generateSetQuestions(set, setKey)}
                            </div>
                        </div>
                    `;
                    setNumber++;
                }
            });

            if (setsHTML) {
                container.innerHTML = `
                    <div class="multi-set-container">
                        <div class="sets-overview" style="text-align: center; margin-bottom: 2rem;">
                            <h2 style="color: white; margin-bottom: 0.5rem;">Comprehensive Practice Questions</h2>
                            <p style="color: #94a3b8; margin: 0;">Multiple question sets with progressive difficulty - like Cengage Learning</p>
                            <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px; border-left: 3px solid #f59e0b; margin: 1rem auto; max-width: 600px; text-align: left;">
                                <strong>Instructions:</strong> Complete all questions first, then click "Submit All" to see your results and explanations.
                            </div>
                        </div>
                        ${setsHTML}
                        <div class="submit-all-section" style="text-align: center; margin: 2rem 0; padding: 2rem; background: rgba(255, 255, 255, 0.02); border-radius: 12px; border: 1px solid var(--glass-border);">
                            <h3 style="color: white; margin-bottom: 1rem;">Ready to Submit?</h3>
                            <p style="color: #94a3b8; margin-bottom: 1.5rem;">Review your answers above, then submit to see results and explanations.</p>
                            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                                <button onclick="submitAllQuestions()" id="submit-all-btn" style="padding: 1rem 2rem; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 1.1rem; font-weight: bold; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3); transition: all 0.3s ease;">
                                    Submit All Questions
                                </button>
                                <button onclick="generateAdaptivePractice()" id="try-again-btn" style="padding: 1rem 2rem; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 1.1rem; font-weight: bold; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); transition: all 0.3s ease; display: none;">
                                    Try Again (Adaptive Learning)
                                </button>
                            </div>
                            <div id="submission-results" style="margin-top: 2rem; display: none;"></div>
                        </div>
                    </div>
                `;
                // Store question sets globally for submission processing
                window.currentQuestionSets = questionSets;
            } else {
                container.innerHTML = '<p>No questions available or invalid format.</p>';
            }
        }

        function getTotalQuestionsInSet(set) {
            let total = 0;
            if (set.multipleChoice) total += set.multipleChoice.length;
            if (set.shortAnswer) total += set.shortAnswer.length; 
            if (set.essay) total += set.essay.length;
            return total;
        }

        function generateSetQuestions(set, setKey) {
            let html = '';
            let questionIndex = 0;

            // Multiple Choice Questions
            if (set.multipleChoice && set.multipleChoice.length > 0) {
                html += `<h4 style="color: #6366f1; margin: 1rem 0;">ðŸ“ Multiple Choice Questions</h4>`;
                set.multipleChoice.forEach((q, i) => {
                    html += `
                        <div class="question-container" data-question-id="${setKey}-mc-${i}" style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                                <h5 style="margin: 0;">Question ${questionIndex + 1}</h5>
                                <span style="background: rgba(99, 102, 241, 0.2); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem;">Difficulty: ${q.difficulty || 'Medium'}</span>
                            </div>
                            <div style="margin: 1rem 0; font-size: 1.1rem; line-height: 1.5;">${q.question}</div>
                            <div class="question-options" style="margin: 1rem 0;">
                                ${q.options.map((option, optIndex) => `
                                    <label class="option-label" style="display: block; margin: 0.5rem 0; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                                        <input type="radio" name="${setKey}-question${i}" value="${optIndex}" data-option="${option}" style="margin-right: 0.5rem;">
                                        ${option}
                                    </label>
                                `).join('')}
                            </div>
                            <div class="question-actions" style="margin: 1rem 0; display: flex; gap: 0.5rem;">
                                ${q.hints && q.hints.length > 0 ? `<button onclick="showMultiSetHint('${setKey}-mc-${i}', '${q.hints[0].replace(/'/g, "\\'")}' )" class="hint-btn" style="padding: 0.75rem 1.5rem; background: rgba(255,255,255,0.1); color: white; border: 1px solid var(--glass-border); border-radius: 8px; cursor: pointer;">ðŸ’¡ Hint</button>` : ''}
                            </div>
                            <div class="question-feedback" id="feedback-${setKey}-mc-${i}" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none;"></div>
                        </div>
                    `;
                    questionIndex++;
                });
            }

            // Short Answer Questions
            if (set.shortAnswer && set.shortAnswer.length > 0) {
                html += `<h4 style="color: #10b981; margin: 1.5rem 0 1rem 0;">âœï¸ Short Answer Questions</h4>`;
                set.shortAnswer.forEach((q, i) => {
                    html += `
                        <div class="question-container" data-question-id="${setKey}-sa-${i}" style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem;">
                            <h5>Question ${questionIndex + 1} (${q.points || 5} points)</h5>
                            <div style="margin: 1rem 0; font-size: 1.1rem; line-height: 1.5;">${q.question}</div>
                            <textarea id="textAnswer-${setKey}-sa-${i}" placeholder="Type your detailed answer here..." style="width: 100%; height: 120px; padding: 0.75rem; border: 1px solid var(--glass-border); border-radius: 8px; background: rgba(255, 255, 255, 0.05); color: white; resize: vertical; font-family: inherit; line-height: 1.5;"></textarea>
                            <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem;">
                                <button onclick="showSampleAnswer('${setKey}-sa-${i}', '${(q.sampleAnswer || '').replace(/'/g, "\\'")}' )" class="hint-btn" style="padding: 0.75rem 1.5rem; background: rgba(16, 185, 129, 0.2); color: white; border: 1px solid #10b981; border-radius: 8px; cursor: pointer;">ðŸ“– Sample Answer</button>
                            </div>
                            <div class="question-feedback" id="feedback-${setKey}-sa-${i}" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none;"></div>
                        </div>
                    `;
                    questionIndex++;
                });
            }

            // Essay Questions  
            if (set.essay && set.essay.length > 0) {
                html += `<h4 style="color: #f59e0b; margin: 1.5rem 0 1rem 0;">ðŸ“„ Essay Questions</h4>`;
                set.essay.forEach((q, i) => {
                    html += `
                        <div class="question-container" data-question-id="${setKey}-essay-${i}" style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem;">
                            <h5>Essay Question ${questionIndex + 1} (${q.points || 20} points)</h5>
                            <div style="margin: 1rem 0; font-size: 1.1rem; line-height: 1.5;">${q.question}</div>
                            ${q.guidelines ? `<div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px; border-left: 3px solid #f59e0b;"><strong>Guidelines:</strong> ${q.guidelines}</div>` : ''}
                            <textarea id="essayAnswer-${setKey}-essay-${i}" placeholder="Write your comprehensive essay response here..." style="width: 100%; height: 200px; padding: 0.75rem; border: 1px solid var(--glass-border); border-radius: 8px; background: rgba(255, 255, 255, 0.05); color: white; resize: vertical; font-family: inherit; line-height: 1.5;"></textarea>
                            <div style="margin-top: 0.5rem;">
                                <!-- Individual submission removed - answers shown after Submit All -->
                            </div>
                            <div class="question-feedback" id="feedback-${setKey}-essay-${i}" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none;"></div>
                        </div>
                    `;
                    questionIndex++;
                });
            }

            return html;
        }

        function flipCard(cardIndex) {
            const card = document.querySelector(`[data-card-id="${cardIndex}"]`);
            if (!card) return;

            card.classList.toggle('flipped');

            const button = card.querySelector('.flip-btn');
            const isFlipped = card.classList.contains('flipped');

            if (button) {
                button.textContent = isFlipped ? 'Show Term' : 'Show Answer';
            }
        }

        function markCard(cardIndex, result) {
            const flashcard = document.querySelector(`[data-card-id="${cardIndex}"]`);

            // Visual feedback
            flashcard.classList.remove('correct', 'incorrect');
            flashcard.classList.add(result);

            // Show toast message
            if (result === 'correct') {
                showToast('Great! Keep it up! ðŸŽ‰', 'success');
            } else {
                showToast('Review this card again later ðŸ“š', 'info');
            }

            // Auto-flip to next card after 1 second
            setTimeout(() => {
                const nextCard = flashcard.nextElementSibling;
                if (nextCard && nextCard.classList.contains('flashcard')) { 
                    const nextInner = nextCard.querySelector('.flashcard-inner');
                    if (nextInner.classList.contains('flipped')) {
                        nextInner.classList.remove('flipped');
                    }
                }
            }, 1000);
        }

        function checkAnswer(questionIndex, correctAnswer, explanation) {
            const questionContainer = document.querySelector(`[data-question-id="${questionIndex}"]`);
            const selectedInput = questionContainer.querySelector('input[type="radio"]:checked');
            const feedbackDiv = document.getElementById(`feedback${questionIndex}`);

            if (!selectedInput) {
                showToast('Please select an answer first!', 'warning');
                return;
            }

            const selectedOption = selectedInput.getAttribute('data-option');
            const isCorrect = selectedOption === correctAnswer;

            // Visual feedback
            questionContainer.classList.remove('correct', 'incorrect');
            questionContainer.classList.add(isCorrect ? 'correct' : 'incorrect');

            // Show feedback
            feedbackDiv.style.display = 'block';
            feedbackDiv.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.5rem; margin-right: 0.5rem;">${isCorrect ? 'âœ…' : 'âŒ'}</span>
                    <strong>${isCorrect ? 'Correct!' : 'Incorrect'}</strong>
                </div>
                <div style="margin-bottom: 0.5rem;">
                    <strong>Correct Answer:</strong> ${correctAnswer}
                </div>
                <div style="font-style: italic;">
                    ${explanation}
                </div>
            `;

            feedbackDiv.style.background = isCorrect ? 
                'rgba(34, 197, 94, 0.1)' : 
                'rgba(239, 68, 68, 0.1)';
            feedbackDiv.style.border = `1px solid ${isCorrect ? 'var(--success)' : '#ef4444'}`;

            // Disable further selection
            const options = questionContainer.querySelectorAll('input[type="radio"]');
            options.forEach(option => option.disabled = true);

            // Hide check button
            const checkBtn = questionContainer.querySelector('.check-btn');
            if (checkBtn) checkBtn.style.display = 'none';

            // Show toast
            showToast(isCorrect ? 'Correct! Well done! ðŸŽ‰' : 'Not quite right. Check the explanation! ðŸ“š', 
                     isCorrect ? 'success' : 'error');
        }

        function submitTextAnswer(questionIndex) {
            const textArea = document.getElementById(`textAnswer${questionIndex}`);
            const feedbackDiv = document.getElementById(`feedback${questionIndex}`);
            const answer = textArea.value.trim();

            if (!answer) {
                showToast('Please write an answer first!', 'warning');
                return;
            }

            // Show feedback for text answers
            feedbackDiv.style.display = 'block';
            feedbackDiv.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.5rem; margin-right: 0.5rem;">âœ…</span>
                    <strong>Answer Submitted!</strong>
                </div>
                <div style="margin-bottom: 0.5rem;">
                    <strong>Your Answer:</strong> ${answer}
                </div>
                <div style="font-style: italic; color: #c4b5fd;">
                    Excellent work on this adaptive question! Continue practicing to strengthen your understanding.
                </div>
            `;

            feedbackDiv.style.background = 'rgba(34, 197, 94, 0.1)';
            feedbackDiv.style.border = '1px solid var(--success)';

            // Disable textarea and button
            textArea.disabled = true;
            const submitBtn = document.querySelector(`button[onclick="submitTextAnswer(${questionIndex})"]`);
            if (submitBtn) submitBtn.style.display = 'none';

            showToast('Answer submitted! ðŸ“', 'success');
        }

        function showHint(questionIndex) {
            const question = window.currentQuestions[questionIndex];
            if (question && question.hints && Array.isArray(question.hints)) {
                showToast(`ðŸ’¡ Hint: ${question.hints[0]}`, 'info');
            } else if (question && question.explanation) {
                showToast(`ðŸ’¡ Think about: ${question.explanation.substring(0, 100)}...`, 'info');
            } else {
                showToast('ðŸ’¡ Think about the key concepts from your study materials!', 'info');
            }
        }

        // Spaced Repetition System (Quizlet-inspired)
        let spacedRepetitionData = {};

        function initializeSpacedRepetition(flashcards) {
            flashcards.forEach((card, index) => {
                if (!spacedRepetitionData[index]) {
                    spacedRepetitionData[index] = {
                        easeFactor: 2.5,
                        interval: 1,
                        repetitions: 0,
                        lastReview: new Date(),
                        nextReview: new Date(Date.now() + 24 * 60 * 60 * 1000), // 1 day
                        memoryStrength: 0.5,
                        reviewCount: 0
                    };
                }
            });
        }

        function markCardWithSpacing(cardIndex, difficulty) {
            const data = spacedRepetitionData[cardIndex];
            const flashcard = document.querySelector(`[data-card-id="${cardIndex}"]`);

            // Update memory strength based on difficulty
            switch (difficulty) {
                case 'easy':
                    data.memoryStrength = Math.min(1.0, data.memoryStrength + 0.3);
                    data.easeFactor = Math.min(2.8, data.easeFactor + 0.1);
                    data.interval = Math.ceil(data.interval * data.easeFactor);
                    break;
                case 'medium':
                    data.memoryStrength = Math.min(1.0, data.memoryStrength + 0.1);
                    data.interval = Math.ceil(data.interval * 1.3);
                    break;
                case 'hard':
                    data.memoryStrength = Math.max(0.1, data.memoryStrength - 0.2);
                    data.easeFactor = Math.max(1.3, data.easeFactor - 0.2);
                    data.interval = Math.max(1, Math.ceil(data.interval * 0.8));
                    break;
            }

            data.repetitions++;
            data.reviewCount++;
            data.lastReview = new Date();
            data.nextReview = new Date(Date.now() + data.interval * 24 * 60 * 60 * 1000);

            // Visual feedback
            flashcard.classList.remove('easy', 'medium', 'hard');
            flashcard.classList.add(difficulty);

            // Update progress display
            updateCardProgress(cardIndex);

            // Show feedback
            const messages = {
                easy: 'ðŸŽ‰ Great! This card will appear less frequently.',
                medium: 'ðŸ‘ Good! Normal review schedule.',
                hard: 'ðŸ¤” No worries! This card will appear more often until you master it.'
            };

            showToast(messages[difficulty], difficulty === 'hard' ? 'warning' : 'success');

            // Auto-advance to next card after feedback
            setTimeout(() => {
                advanceToNextCard(cardIndex);
            }, 1500);
        }

        function getCardProgress(cardIndex) {
            const data = spacedRepetitionData[cardIndex];
            if (!data) return 0;
            return Math.round(data.memoryStrength * 100);
        }

        function getNextReviewTime(cardIndex) {
            const data = spacedRepetitionData[cardIndex];
            if (!data) return 'Not scheduled';

            const now = new Date();
            const diffMs = data.nextReview - now;

            if (diffMs <= 0) return 'Ready now!';

            const diffDays = Math.ceil(diffMs / (24 * 60 * 60 * 1000));
            if (diffDays === 1) return 'Tomorrow';
            if (diffDays < 7) return `${diffDays} days`;
            if (diffDays < 30) return `${Math.ceil(diffDays / 7)} weeks`;
            return `${Math.ceil(diffDays / 30)} months`;
        }

        function updateCardProgress(cardIndex) {
            const flashcard = document.querySelector(`[data-card-id="${cardIndex}"]`);
            if (!flashcard) return;

            const progressFill = flashcard.querySelector('.progress-fill');
            const nextReviewSpan = flashcard.querySelector('.next-review');

            if (progressFill) {
                progressFill.style.width = `${getCardProgress(cardIndex)}%`;
            }

            if (nextReviewSpan) {
                nextReviewSpan.textContent = `Next review: ${getNextReviewTime(cardIndex)}`;
            }
        }

        function checkAdaptiveAnswer(questionIndex, correctAnswer, explanation, focusArea) {
            const questionContainer = document.querySelector(`[data-question-id="adaptive-${questionIndex}"]`);
            const selectedInput = questionContainer.querySelector('input[type="radio"]:checked');
            const feedbackDiv = document.getElementById(`adaptive-feedback${questionIndex}`);

            if (!selectedInput) {
                showToast('Please select an answer first!', 'warning');
                return;
            }

            const selectedOption = selectedInput.getAttribute('data-option');
            const isCorrect = selectedOption === correctAnswer;

            // Visual feedback
            questionContainer.classList.remove('correct', 'incorrect');
            questionContainer.classList.add(isCorrect ? 'correct' : 'incorrect');

            // Show feedback
            feedbackDiv.style.display = 'block';
            feedbackDiv.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.5rem; margin-right: 0.5rem;">${isCorrect ? 'âœ…' : 'âŒ'}</span>
                    <strong>${isCorrect ? 'Excellent!' : 'Not quite right'}</strong>
                </div>
                <div style="margin-bottom: 0.5rem;">
                    <strong>Your Answer:</strong> ${selectedOption}
                </div>
                <div style="margin-bottom: 0.5rem;">
                    <strong>Correct Answer:</strong> ${correctAnswer}
                </div>
                <div style="margin-bottom: 0.5rem;">
                    <strong>Explanation:</strong> ${explanation}
                </div>
                <div style="font-size: 0.9rem; color: #94a3b8;">
                    <strong>Focus Area:</strong> ${focusArea}
                </div>
            `;

            feedbackDiv.style.background = isCorrect ? 
                'rgba(34, 197, 94, 0.1)' : 
                'rgba(239, 68, 68, 0.1)';
            feedbackDiv.style.border = `1px solid ${isCorrect ? 'var(--success)' : '#ef4444'}`;

            // Disable further selection
            const options = questionContainer.querySelectorAll('input[type="radio"]');
            options.forEach(option => option.disabled = true);

            // Hide check button
            const checkBtn = questionContainer.querySelector('.check-btn');
            if (checkBtn) checkBtn.style.display = 'none';

            // Show appropriate toast
            if (isCorrect) {
                showToast('Correct! You\'re improving in this area! ðŸŽ‰', 'success');
            } else {
                showToast('Keep practicing this concept! ðŸ“š', 'error');
            }
        }

        function showAdaptiveHint(questionIndex, hint) {
            const feedbackDiv = document.getElementById(`adaptive-feedback${questionIndex}`);
            feedbackDiv.style.display = 'block';
            feedbackDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.2rem;">ðŸ’¡</span>
                    <strong>Hint</strong>
                </div>
                <div>${hint}</div>
            `;
            feedbackDiv.style.backgroundColor = 'rgba(99, 102, 241, 0.1)';
            feedbackDiv.style.borderLeft = '3px solid #6366f1';
        }

        function submitAllQuestions() {
            console.log('ðŸ” Starting submit all questions process...');
            
            if (!window.currentQuestionSets) {
                showToast('No questions to submit. Please generate questions first.', 'error');
                return;
            }
            
            const allAnswers = {};
            let totalQuestions = 0;
            let answeredQuestions = 0;
            
            // Collect all answers from all question sets
            Object.keys(window.currentQuestionSets).forEach(setKey => {
                const set = window.currentQuestionSets[setKey];
                allAnswers[setKey] = {
                    multipleChoice: {},
                    shortAnswer: {},
                    essay: {}
                };
                
                // Multiple choice answers
                if (set.multipleChoice) {
                    set.multipleChoice.forEach((q, i) => {
                        totalQuestions++;
                        const selectedOption = document.querySelector(`input[name="mc-${setKey}-${i}"]:checked`);
                        if (selectedOption) {
                            answeredQuestions++;
                            allAnswers[setKey].multipleChoice[i] = {
                                question: q.question,
                                userAnswer: selectedOption.value,
                                correctAnswer: q.correctAnswer,
                                explanation: q.explanation,
                                isCorrect: selectedOption.value === q.correctAnswer
                            };
                        }
                    });
                }
                
                // Short answer responses
                if (set.shortAnswer) {
                    set.shortAnswer.forEach((q, i) => {
                        totalQuestions++;
                        const textarea = document.getElementById(`shortAnswer-${setKey}-${i}`);
                        if (textarea && textarea.value.trim()) {
                            answeredQuestions++;
                            allAnswers[setKey].shortAnswer[i] = {
                                question: q.question,
                                userAnswer: textarea.value.trim(),
                                sampleAnswer: q.sampleAnswer,
                                points: q.points || 5
                            };
                        }
                    });
                }
                
                // Essay responses
                if (set.essay) {
                    set.essay.forEach((q, i) => {
                        totalQuestions++;
                        const textarea = document.getElementById(`essayAnswer-${setKey}-essay-${i}`);
                        if (textarea && textarea.value.trim()) {
                            answeredQuestions++;
                            allAnswers[setKey].essay[i] = {
                                question: q.question,
                                userAnswer: textarea.value.trim(),
                                guidelines: q.guidelines,
                                points: q.points || 20
                            };
                        }
                    });
                }
            });
            
            // Check if questions are answered (at least 70% for flexibility)
            const completionRate = (answeredQuestions / totalQuestions) * 100;
            
            if (completionRate < 50) {
                showToast(`Please answer more questions before submitting. Current: ${Math.round(completionRate)}%`, 'warning');
                return;
            }
            
            console.log(`ðŸ“Š Submitting ${answeredQuestions}/${totalQuestions} questions (${Math.round(completionRate)}%)`);
            
            // Calculate scoring for multiple choice
            let correctCount = 0;
            let mcCount = 0;
            
            Object.keys(allAnswers).forEach(setKey => {
                const setResults = allAnswers[setKey];
                
                // Process multiple choice and show immediate feedback
                Object.keys(setResults.multipleChoice).forEach(i => {
                    mcCount++;
                    const answer = setResults.multipleChoice[i];
                    if (answer.isCorrect) correctCount++;
                    
                    // Show feedback for this question
                    const questionContainer = document.querySelector(`[data-mc-question="${setKey}-${i}"]`);
                    if (questionContainer) {
                        let feedbackDiv = questionContainer.querySelector('.question-feedback');
                        if (!feedbackDiv) {
                            feedbackDiv = document.createElement('div');
                            feedbackDiv.className = 'question-feedback';
                            questionContainer.appendChild(feedbackDiv);
                        }
                        
                        feedbackDiv.style.display = 'block';
                        feedbackDiv.innerHTML = `
                            <div style="background: ${answer.isCorrect ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; padding: 1rem; border-radius: 8px; border-left: 3px solid ${answer.isCorrect ? '#22c55e' : '#ef4444'}; margin-top: 1rem;">
                                <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="font-size: 1.5rem; margin-right: 0.5rem;">${answer.isCorrect ? 'âœ…' : 'âŒ'}</span>
                                    <strong>${answer.isCorrect ? 'Correct!' : 'Incorrect'}</strong>
                                </div>
                                <div style="margin-bottom: 0.5rem;"><strong>Your Answer:</strong> ${answer.userAnswer}</div>
                                <div style="margin-bottom: 0.5rem;"><strong>Correct Answer:</strong> ${answer.correctAnswer}</div>
                                <div style="color: #e2e8f0;"><strong>Explanation:</strong> ${answer.explanation}</div>
                            </div>
                        `;
                    }
                });
            });
            
            // Calculate final percentage
            const finalPercentage = mcCount > 0 ? Math.round((correctCount / mcCount) * 100) : 0;
            
            // Show comprehensive results at top
            const resultsHTML = `
                <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1)); padding: 2rem; border-radius: 12px; border: 1px solid rgba(34, 197, 94, 0.3); margin: 2rem 0; text-align: center;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">ðŸŽ‰</div>
                    <h2 style="color: #22c55e; margin-bottom: 1rem;">Quiz Results!</h2>
                    <div style="display: flex; justify-content: space-around; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; min-width: 120px;">
                            <div style="font-size: 1.8rem; font-weight: bold; color: #22c55e;">${finalPercentage}%</div>
                            <div style="color: #94a3b8; font-size: 0.9rem;">Score</div>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; min-width: 120px;">
                            <div style="font-size: 1.8rem; font-weight: bold; color: #22c55e;">${correctCount}/${mcCount}</div>
                            <div style="color: #94a3b8; font-size: 0.9rem;">Correct</div>
                        </div>
                    </div>
                    <div style="color: #e2e8f0; margin-bottom: 1rem; font-size: 1.1rem;">
                        ${finalPercentage >= 90 ? 'ðŸŒŸ Excellent! Outstanding performance!' : 
                          finalPercentage >= 80 ? 'ðŸ‘ Great job! Very well done!' : 
                          finalPercentage >= 70 ? 'ðŸ“š Good work! Keep it up!' : 
                          finalPercentage >= 60 ? 'ðŸ’ª Not bad! Room for improvement!' : 
                          'ðŸ”„ Keep studying and try again!'}
                    </div>
                    <p style="color: #94a3b8; font-size: 0.9rem;">Scroll down to see detailed explanations for each question</p>
                </div>
            `;
            
            // Insert results at the top of practice content
            const practiceContent = document.getElementById('practiceContent');
            if (practiceContent) {
                const existingResults = practiceContent.querySelector('.quiz-results');
                if (existingResults) {
                    existingResults.remove();
                }
                
                const resultDiv = document.createElement('div');
                resultDiv.className = 'quiz-results';
                resultDiv.innerHTML = resultsHTML;
                practiceContent.insertBefore(resultDiv, practiceContent.firstChild);
            }
            
            // Update submit button
            const submitBtn = document.getElementById('submit-all-btn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'âœ… Results Shown Above';
                submitBtn.style.background = '#22c55e';
                submitBtn.style.opacity = '0.7';
            }
            
            // Scroll to results smoothly
            if (practiceContent) {
                practiceContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            showToast(`ðŸŽ‰ Quiz completed! You scored ${finalPercentage}%`, 'success');
            console.log('âœ… Submit all questions completed successfully');
        }

        function submitAdaptiveAnswer(questionIndex) {
            const textArea = document.getElementById(`adaptiveAnswer${questionIndex}`);
            const feedbackDiv = document.getElementById(`adaptive-feedback${questionIndex}`);
            const answer = textArea.value.trim();

            if (!answer) {
                showToast('Please write an answer first!', 'warning');
                return;
            }

            feedbackDiv.style.display = 'block';
            feedbackDiv.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.5rem; margin-right: 0.5rem;">âœ…</span>
                    <strong>Answer Submitted!</strong>
                </div>
                <div style="margin-bottom: 0.5rem;">
                    <strong>Your Answer:</strong> ${answer}
                </div>
                <div style="font-style: italic; color: #c4b5fd;">
                    Excellent work on this adaptive question! Continue practicing to strengthen your understanding.
                </div>
            `;

            feedbackDiv.style.background = 'rgba(34, 197, 94, 0.1)';
            feedbackDiv.style.border = '1px solid var(--success)';

            // Disable textarea and button
            textArea.disabled = true;
            const submitBtn = document.querySelector(`button[onclick="submitAdaptiveAnswer(${questionIndex})"]`);
            if (submitBtn) submitBtn.style.display = 'none';

            showToast('Adaptive answer submitted! Keep practicing! ðŸ“', 'success');
        }

        function advanceToNextCard(currentIndex) {
            const allCards = document.querySelectorAll('.flashcard');
            const nextIndex = (currentIndex + 1) % allCards.length;
            const nextCard = allCards[nextIndex];

            if (nextCard) {
                nextCard.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Reset the next card if it's flipped
                const nextInner = nextCard.querySelector('.flashcard-inner');
                if (nextInner && nextInner.classList.contains('flipped')) {
                    nextInner.classList.remove('flipped');
                }
            }
        }

        async function generateMoreFlashcards() {
            if (!isLoggedIn || !currentFileIds || currentFileIds.length === 0) {
                showToast('Please upload files and login first', 'error');
                return;
            }

            const studyMoreBtn = document.getElementById('study-more-flashcards');
            const originalText = studyMoreBtn.textContent;
            studyMoreBtn.textContent = 'â³ Generating...';
            studyMoreBtn.disabled = true;

            try {
                // Collect existing flashcard terms to avoid duplicates
                const existingCards = document.querySelectorAll('.flashcard');
                const existingTerms = Array.from(existingCards).map(card => {
                    const term = card.querySelector('h3');
                    return term ? term.textContent.trim() : '';
                }).filter(term => term);

                console.log(`ðŸ“š Generating more flashcards, avoiding ${existingTerms.length} existing terms`);

                const result = await api.makeRequest('/api/generate-more-flashcards', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        fileIds: currentFileIds,
                        existingTerms: existingTerms
                    })
                });

                if (result.success && result.data.flashcards) {
                    // Append new flashcards to existing ones
                    const container = document.getElementById('flashcardsContent');
                    const flashcardContainer = container.querySelector('.flashcard-container') || 
                                             container.querySelector('#flashcards-container');
                    
                    if (flashcardContainer) {
                        const newFlashcardsHTML = result.data.flashcards.map((card, index) => {
                            const cardIndex = existingCards.length + index; // Continue numbering from existing cards
                            return generateFlashcardHTML(card, cardIndex);
                        }).join('');
                        
                        flashcardContainer.insertAdjacentHTML('beforeend', newFlashcardsHTML);
                    } else {
                        // If no container exists, create one and add all cards
                        displayFlashcards(result.data.flashcards);
                    }

                    // Update the button text to show total cards
                    const totalCards = document.querySelectorAll('.flashcard').length;
                    studyMoreBtn.textContent = `ðŸ“š Study Even More (+6 cards) - Total: ${totalCards}`;
                    
                    showToast(`âœ¨ Added ${result.data.flashcards.length} more flashcards!`, 'success');
                    console.log(`âœ… Added ${result.data.flashcards.length} new flashcards`);

                } else {
                    throw new Error(result.error || 'Failed to generate additional flashcards');
                }

            } catch (error) {
                console.error('âŒ Error generating more flashcards:', error);
                showToast('Failed to generate more flashcards: ' + error.message, 'error');
            } finally {
                studyMoreBtn.textContent = originalText;
                studyMoreBtn.disabled = false;
            }
        }

        function generateFlashcardHTML(card, index) {
            const term = card.term || card.front || card.question || 'Concept';
            const definition = card.definition || card.back || card.answer || 'Definition not available';
            const difficulty = card.difficulty || 3;
            const importance = card.importance || 3;
            const category = card.category || 'General';

            const isSimpleCard = !card.multipleExamples && !card.connections && !card.commonMisconceptions && !card.visualDescription && !card.mnemonic;

            return `
                <div class="flashcard ${isSimpleCard ? 'simple-card' : 'complex-card'}" data-card-id="${index}" data-difficulty="${difficulty}" data-importance="${importance}">
                    <div class="flashcard-header">
                        <div class="card-meta">
                            <span class="difficulty-indicator">Level ${difficulty}</span>
                            <span class="category-tag">${category}</span>
                            <span class="importance-stars">${'â˜…'.repeat(Math.min(importance, 5))}</span>
                        </div>
                    </div>
                    <div class="flashcard-inner">
                        <div class="flashcard-front">
                            <div class="card-content" style="display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; min-height: ${isSimpleCard ? '200px' : '300px'};">
                                <h3 style="margin-bottom: 1.5rem; color: white; font-size: ${isSimpleCard ? '1.5rem' : '1.3rem'}; font-weight: bold;">${term}</h3>
                                ${!isSimpleCard ? `
                                    ${card.memoryTips ? `<div class="memory-tip" style="margin: 0.5rem 0; padding: 0.75rem; background: rgba(99, 102, 241, 0.1); border-radius: 8px; border-left: 3px solid #6366f1;">ðŸ’¡ <strong>Memory Tip:</strong> ${card.memoryTips}</div>` : ''}
                                    ${card.visualDescription ? `<div class="visual-tip" style="margin: 0.5rem 0; padding: 0.75rem; background: rgba(168, 85, 247, 0.1); border-radius: 8px; border-left: 3px solid #a855f7;">ðŸ–¼ï¸ <strong>Visualize:</strong> ${card.visualDescription}</div>` : ''}
                                    ${card.mnemonic ? `<div class="mnemonic-tip" style="margin: 0.5rem 0; padding: 0.75rem; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border-left: 3px solid #22c55e;">ðŸ§  <strong>Remember:</strong> ${card.mnemonic}</div>` : ''}
                                ` : ''}
                            </div>
                            <div class="card-actions">
                                <button class="flip-btn" onclick="flipCard(${index})" style="padding: 1rem 2rem; font-size: 1.1rem; font-weight: bold;">Show Answer</button>
                            </div>
                        </div>
                        <div class="flashcard-back">
                            <div class="card-content" style="display: flex; flex-direction: column; justify-content: flex-start; min-height: ${isSimpleCard ? '200px' : '300px'};">
                                <div class="definition" style="margin-bottom: 1.5rem; line-height: 1.6; font-size: ${isSimpleCard ? '1.1rem' : '1rem'}; text-align: ${isSimpleCard ? 'center' : 'left'}; ${isSimpleCard ? 'display: flex; align-items: center; justify-content: center; flex-grow: 1;' : ''}">${definition}</div>

                                ${!isSimpleCard ? `
                                    ${card.multipleExamples && Array.isArray(card.multipleExamples) && card.multipleExamples.length > 0 ? `
                                        <div class="examples" style="background: rgba(34, 197, 94, 0.1); padding: 1rem; border-radius: 8px; border-left: 3px solid #22c55e; margin: 0.5rem 0;">
                                            <strong style="color: #4ade80;">ðŸ“ Examples:</strong>
                                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">${card.multipleExamples.map(ex => `<li style="margin: 0.3rem 0; color: #a7f3d0;">${ex}</li>`).join('')}</ul>
                                        </div>
                                    ` : ''}

                                    ${card.connections && Array.isArray(card.connections) && card.connections.length > 0 ? `
                                        <div class="connections" style="background: rgba(6, 182, 212, 0.1); padding: 1rem; border-radius: 8px; margin: 0.5rem 0; border-left: 3px solid #06b6d4;">
                                            <strong style="color: #22d3ee;">ðŸ”— Connections:</strong>
                                            <div class="connection-tags" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                                                ${card.connections.map(conn => `<span class="connection-tag" style="background: rgba(6, 182, 212, 0.2); border: 1px solid #06b6d4; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; color: #67e8f9;">${conn}</span>`).join('')}
                                            </div>
                                        </div>
                                    ` : ''}

                                    ${card.commonMisconceptions && Array.isArray(card.commonMisconceptions) && card.commonMisconceptions.length > 0 ? `
                                        <div class="misconceptions" style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 8px; margin: 0.5rem 0; border-left: 3px solid #ef4444;">
                                            <strong style="color: #f87171;">âš ï¸ Common Misconceptions:</strong>
                                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">${card.commonMisconceptions.map(misc => `<li style="margin: 0.3rem 0; color: #fecaca;">${misc}</li>`).join('')}</ul>
                                        </div>
                                    ` : ''}

                                    ${card.practiceQuestion ? `
                                        <div class="practice-question" style="background: rgba(168, 85, 247, 0.1); padding: 0.75rem; border-radius: 8px; margin: 0.5rem 0; border-left: 3px solid #a855f7;">
                                            <strong style="color: #c4b5fd;">ðŸ¤” Test Yourself:</strong>
                                            <div class="practice-q" style="margin-top: 0.5rem; font-style: italic; color: #e9d5ff;">${card.practiceQuestion}</div>
                                        </div>
                                    ` : ''}
                                ` : ''}
                            </div>
                            <div class="card-actions">
                                <button class="feedback-btn easy" onclick="markCardWithSpacing(${index}, 'easy')" style="padding: ${isSimpleCard ? '0.75rem 1.5rem' : '0.5rem 1rem'};">ðŸ˜Š Easy</button>
                                <button class="feedback-btn medium" onclick="markCardWithSpacing(${index}, 'medium')" style="padding: ${isSimpleCard ? '0.75rem 1.5rem' : '0.5rem 1rem'};">ðŸ˜ Medium</button>
                                <button class="feedback-btn hard" onclick="markCardWithSpacing(${index}, 'hard')" style="padding: ${isSimpleCard ? '0.75rem 1.5rem' : '0.5rem 1rem'};">ðŸ˜“ Hard</button>
                                <button class="flip-btn" onclick="flipCard(${index})" style="padding: ${isSimpleCard ? '0.75rem 1.5rem' : '0.5rem 1rem'};">Back to Question</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${getCardProgress(index)}%"></div>
                        </div>
                        <span class="next-review">Next review: ${getNextReviewTime(index)}</span>
                    </div>
                </div>
            `;
        }

        function displayStudyPlan(studyPlan) {
            const container = document.querySelector('.study-plan');
            console.log('ðŸ“… Displaying study plan:', studyPlan);

            if (!container) {
                console.error('âŒ Study plan container not found');
                return;
            }

            if (Array.isArray(studyPlan)) {
                // Handle array format - each item has tasks, timeRequired, topics, reviewItems
                container.innerHTML = studyPlan.map((day, index) => {
                    if (typeof day === 'object' && day.tasks && Array.isArray(day.tasks)) {
                        return day.tasks.map(task => `
                            <div class="study-plan-item">
                                <div class="study-plan-check" onclick="toggleCheck(this)"></div>
                                <span>${task} ${day.timeRequired ? `(${day.timeRequired})` : ''}</span>
                            </div>
                        `).join('');
                    } else if (typeof day === 'string') {
                        return `
                            <div class="study-plan-item">
                                <div class="study-plan-check" onclick="toggleCheck(this)"></div>
                                <span>${day}</span>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="study-plan-item">
                                <div class="study-plan-check" onclick="toggleCheck(this)"></div>
                                <span>Day ${index + 1}: ${JSON.stringify(day)}</span>
                            </div>
                        `;
                    }
                }).join('');
            } else if (typeof studyPlan === 'object') {
                // Handle object format (day1, day2, etc.)
                const days = Object.values(studyPlan);
                container.innerHTML = days.map((day, index) => {
                    if (typeof day === 'object' && day.tasks) {
                        return day.tasks.map(task => `
                            <div class="study-plan-item">
                                <div class="study-plan-check" onclick="toggleCheck(this)"></div>
                                <span>${task} ${day.timeRequired ? `(${day.timeRequired})` : ''}</span>
                            </div>
                        `).join('');
                    } else {
                        return `
                            <div class="study-plan-item">
                                <div class="study-plan-check" onclick="toggleCheck(this)"></div>
                                <span>${day}</span>
                            </div>
                        `;
                    }
                }).join('');
            } else {
                console.error('âŒ Invalid study plan format:', studyPlan);
                container.innerHTML = `
                    <div class="study-plan-item">
                        <div class="study-plan-check" onclick="toggleCheck(this)"></div>
                        <span>AI-generated study plan available</span>
                    </div>
                `;
            }

            console.log('âœ… Study plan updated in UI');
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();

            if (!message) return;

            if (!isLoggedIn) {
                showToast('Please login to use AI chat', 'error');
                showLogin();
                return;
            }

            addChatMessage('user', message);
            chatInput.value = '';

            try {
                const result = await api.sendChatMessage(message, currentSession || 'demo-session');

                if (result.success) {
                    addChatMessage('ai', result.data.response);
                } else {
                    addChatMessage('ai', 'Sorry, I encountered an error: ' + result.error);
                }
            } catch (error) {
                addChatMessage('ai', 'Sorry, I\'m having trouble connecting.');
            }
        }

        function addChatMessage(sender, message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = `<p>${message}</p>`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function toggleCheck(checkbox) {
            checkbox.classList.toggle('checked');
            updateProgress();
        }

        function updateProgress() {
            const checkedItems = document.querySelectorAll('.study-plan-check.checked').length;
            const totalItems = document.querySelectorAll('.study-plan-check').length;
            const progress = totalItems > 0 ? (checkedItems / totalItems) * 100 : 0;

            const circle = document.getElementById('progressCircle');
            if (circle) {
                const circumference = 2 * Math.PI * 54;
                const offset = circumference - (progress / 100) * circumference;
                circle.style.strokeDashoffset = offset;
            }

            const progressText = document.getElementById('progressText');
            if (progressText) {
                progressText.textContent = Math.round(progress) + '%';
            }
        }

        function showToast(message, type = 'success') {
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const icon = document.querySelector('.theme-toggle i');
            if (icon) {
                icon.className = document.body.classList.contains('dark-mode') ? 
                    'fa-solid fa-sun' : 'fa-solid fa-moon';
            }
        }

        // Debug utilities for console
        window.debugStudyMaster = {
            testConnection: () => api.testConnection(),
            checkAuth: () => {
                console.log('Auth Status:', {
                    hasToken: api.isAuthenticated(),
                    token: api.token ? '***' + api.token.slice(-10) : null,
                    userId: api.userId,
                    backendURL: api.baseURL
                });
            },
            clearStorage: () => {
                localStorage.clear();
                sessionStorage.clear();
                console.log('Storage cleared');
                location.reload();
            },
            setBackend: (url) => {
                api.baseURL = url;
                console.log('Backend URL changed to:', url);
                return api.testConnection();
            }
        };

        // Comprehensive frontend test function
        window.testFrontendDisplays = function() {
            console.log('ðŸ§ª Testing all frontend displays...');

            const tests = {
                landingPage: !!document.getElementById('landingPage'),
                dashboard: !!document.getElementById('dashboard'),
                authModal: !!document.getElementById('authModal'),
                uploadArea: !!document.getElementById('uploadArea'),
                fileList: !!document.getElementById('fileList'),
                processBtn: !!document.getElementById('processBtn'),
                chatMessages: !!document.getElementById('chatMessages'),
                summaryContent: !!document.getElementById('summaryContent'),
                flashcardsContent: !!document.getElementById('flashcardsContent'),
                practiceContent: !!document.getElementById('practiceContent'),
                connectionStatus: !!document.getElementById('connectionStatus'),
                totalStudyTime: !!document.getElementById('totalStudyTime'),
                cardsReviewed: !!document.getElementById('cardsReviewed'),
                accuracy: !!document.getElementById('accuracy'),
                mastery: !!document.getElementById('mastery')
            };

            console.log('ðŸ“Š Frontend Element Check:', tests);

            const missing = Object.keys(tests).filter(key => !tests[key]);
            if (missing.length > 0) {
                console.warn('âŒ Missing elements:', missing);
            } else {
                console.log('âœ… All frontend elements present');
            }

            return tests;
        };

        // Comprehensive API connection test
        window.testAPIConnections = async function() {
            console.log('ðŸ§ª Testing API connections...');
            
            const tests = {
                health: { endpoint: '/health', auth: false },
                testConnection: { endpoint: '/test-connection', auth: false },
                stats: { endpoint: '/api/stats/demo', auth: false }
            };

            const results = {};

            for (const [testName, config] of Object.entries(tests)) {
                try {
                    console.log(`ðŸ”„ Testing ${testName}...`);
                    const result = await api.makeRequest(config.endpoint);
                    results[testName] = {
                        success: result.success,
                        data: result.data || result.error,
                        baseURL: api.baseURL
                    };
                    console.log(`âœ… ${testName}: SUCCESS`);
                } catch (error) {
                    results[testName] = {
                        success: false,
                        error: error.message,
                        baseURL: api.baseURL
                    };
                    console.log(`âŒ ${testName}: FAILED -`, error.message);
                }
            }

            console.log('ðŸ“Š API Test Results:', results);
            return results;
        };

        // Full system test
        window.runFullSystemTest = async function() {
            console.log('ðŸš€ Running full system test...');
            
            const frontendTests = window.testFrontendDisplays();
            const apiTests = await window.testAPIConnections();
            
            const summary = {
                frontend: {
                    total: Object.keys(frontendTests).length,
                    passed: Object.values(frontendTests).filter(Boolean).length,
                    failed: Object.values(frontendTests).filter(v => !v).length
                },
                api: {
                    total: Object.keys(apiTests).length,
                    passed: Object.values(apiTests).filter(r => r.success).length,
                    failed: Object.values(apiTests).filter(r => !r.success).length
                },
                backend: {
                    url: api.baseURL,
                    connected: api.isAuthenticated() && Object.values(apiTests).some(r => r.success)
                }
            };

            console.log('ðŸ“‹ FULL SYSTEM TEST SUMMARY:');
            console.log('Frontend Elements:', `${summary.frontend.passed}/${summary.frontend.total} âœ…`);
            console.log('API Endpoints:', `${summary.api.passed}/${summary.api.total} âœ…`);
            console.log('Backend Connection:', summary.backend.connected ? 'âœ… Connected' : 'âŒ Disconnected');
            console.log('Active Backend URL:', summary.backend.url);

            return summary;
        };

        // Enhanced UI Display Tests
        window.testUIFunctionality = function() {
            console.log('ðŸŽ¨ Testing UI functionality and displays...');
            
            const uiTests = {
                // Navigation and Layout
                navigationVisible: !!document.querySelector('.navbar') || !!document.querySelector('.header'),
                logoDisplay: !!document.querySelector('.logo'),
                
                // Landing Page Elements
                landingPageElements: {
                    heroSection: !!document.querySelector('.hero'),
                    heroTitle: !!document.querySelector('.hero-title'),
                    pricingComparison: !!document.querySelector('.pricing-comparison'),
                    ctaButton: !!document.querySelector('.btn-cta')
                },
                
                // Dashboard Elements
                dashboardElements: {
                    statsGrid: !!document.querySelector('.stats-grid'),
                    uploadArea: !!document.querySelector('.upload-area'),
                    studyModes: !!document.querySelector('.study-modes'),
                    processButton: !!document.querySelector('#processBtn'),
                    progressRing: !!document.querySelector('.progress-ring')
                },
                
                // Content Tabs
                contentTabs: {
                    tabsContainer: !!document.querySelector('.content-tabs'),
                    aiTutorTab: !!document.querySelector('[data-tab="ai-tutor"]'),
                    summaryTab: !!document.querySelector('[data-tab="summary"]'),
                    flashcardsTab: !!document.querySelector('[data-tab="flashcards"]'),
                    practiceTab: !!document.querySelector('[data-tab="practice"]')
                },
                
                // Interactive Elements
                interactiveElements: {
                    chatInput: !!document.querySelector('#chatInput'),
                    sendButton: !!document.querySelector('#sendBtn'),
                    fileInput: !!document.querySelector('#fileInput'),
                    authModal: !!document.querySelector('#authModal'),
                    authForm: !!document.querySelector('#authForm')
                },
                
                // Styling and Visual Elements
                visualElements: {
                    backgroundGradient: !!document.querySelector('.bg-gradient'),
                    glassmorphism: document.querySelectorAll('.card').length > 0,
                    responsiveLayout: window.getComputedStyle(document.querySelector('.main-layout') || document.body).display !== 'none',
                    fontAwesome: !!document.querySelector('link[href*="font-awesome"]')
                }
            };

            // Test interactive functionality
            const functionalityTests = {
                tabSwitching: testTabSwitching(),
                modeSelection: testModeSelection(),
                dragAndDrop: testDragDropFunctionality(),
                authModal: testAuthModalFunctionality(),
                chatInterface: testChatInterface(),
                fileUpload: testFileUploadInterface(),
                progressTracking: testProgressTracking(),
                flashcardFlipping: testFlashcardFunctionality(),
                responsiveDesign: testResponsiveDesign()
            };

            console.log('ðŸ“Š UI Elements Test Results:', uiTests);
            console.log('âš¡ Functionality Test Results:', functionalityTests);
            
            const totalUITests = countNestedTests(uiTests);
            const passedUITests = countPassedNestedTests(uiTests);
            const totalFuncTests = Object.keys(functionalityTests).length;
            const passedFuncTests = Object.values(functionalityTests).filter(Boolean).length;
            
            console.log(`ðŸ“‹ UI ELEMENTS: ${passedUITests}/${totalUITests} âœ…`);
            console.log(`âš¡ FUNCTIONALITY: ${passedFuncTests}/${totalFuncTests} âœ…`);
            
            return { uiTests, functionalityTests };
        };

        function countNestedTests(obj) {
            let count = 0;
            for (const key in obj) {
                if (typeof obj[key] === 'object' && !Array.isArray(obj[key])) {
                    count += countNestedTests(obj[key]);
                } else {
                    count++;
                }
            }
            return count;
        }

        function countPassedNestedTests(obj) {
            let count = 0;
            for (const key in obj) {
                if (typeof obj[key] === 'object' && !Array.isArray(obj[key])) {
                    count += countPassedNestedTests(obj[key]);
                } else if (obj[key]) {
                    count++;
                }
            }
            return count;
        }

        function testTabSwitching() {
            try {
                const tabs = document.querySelectorAll('.tab');
                const contents = document.querySelectorAll('.tab-content');
                return tabs.length > 0 && contents.length > 0;
            } catch (e) {
                return false;
            }
        }

        function testModeSelection() {
            try {
                const modeButtons = document.querySelectorAll('.mode-btn');
                return modeButtons.length >= 4; // Should have 4 study modes
            } catch (e) {
                return false;
            }
        }

        function testDragDropFunctionality() {
            try {
                const uploadArea = document.querySelector('.upload-area');
                return uploadArea && uploadArea.addEventListener;
            } catch (e) {
                return false;
            }
        }

        function testAuthModalFunctionality() {
            try {
                const authModal = document.querySelector('#authModal');
                const authForm = document.querySelector('#authForm');
                return authModal && authForm;
            } catch (e) {
                return false;
            }
        }

        function testChatInterface() {
            try {
                const chatMessages = document.querySelector('#chatMessages');
                const chatInput = document.querySelector('#chatInput');
                const sendBtn = document.querySelector('#sendBtn');
                return chatMessages && chatInput && sendBtn;
            } catch (e) {
                return false;
            }
        }

        function testFileUploadInterface() {
            try {
                const fileInput = document.querySelector('#fileInput');
                const fileList = document.querySelector('#fileList');
                return fileInput && fileList;
            } catch (e) {
                return false;
            }
        }

        function testProgressTracking() {
            try {
                const progressRing = document.querySelector('.progress-ring');
                const statsGrid = document.querySelector('.stats-grid');
                return progressRing && statsGrid;
            } catch (e) {
                return false;
            }
        }

        function testFlashcardFunctionality() {
            try {
                const flashcardsContainer = document.querySelector('#flashcardsContent');
                return !!flashcardsContainer;
            } catch (e) {
                return false;
            }
        }

        function testResponsiveDesign() {
            try {
                const mainLayout = document.querySelector('.main-layout');
                if (!mainLayout) return false;
                
                const computedStyle = window.getComputedStyle(mainLayout);
                return computedStyle.display === 'grid' || computedStyle.display === 'flex';
            } catch (e) {
                return false;
            }
        }

        // Visual Display Test
        window.testVisualDisplays = function() {
            console.log('ðŸŽ¨ Testing visual displays and styling...');
            
            const visualTests = {
                // Color scheme and theming
                colorScheme: {
                    cssVariables: getComputedStyle(document.documentElement).getPropertyValue('--primary') !== '',
                    darkMode: document.body.classList.contains('dark-mode') || getComputedStyle(document.body).backgroundColor.includes('rgb'),
                    gradientBackground: !!document.querySelector('.bg-gradient'),
                    glassmorphism: checkGlassmorphismEffects()
                },
                
                // Typography
                typography: {
                    fontLoaded: getComputedStyle(document.body).fontFamily.includes('Inter') || getComputedStyle(document.body).fontFamily !== 'serif',
                    headingStyles: !!document.querySelector('h1, h2, h3'),
                    fontAwesome: !!document.querySelector('link[href*="font-awesome"]')
                },
                
                // Layout and positioning
                layout: {
                    flexboxUsed: Array.from(document.querySelectorAll('*')).some(el => 
                        getComputedStyle(el).display === 'flex'),
                    gridUsed: Array.from(document.querySelectorAll('*')).some(el => 
                        getComputedStyle(el).display === 'grid'),
                    responsiveBreakpoints: checkResponsiveBreakpoints()
                },
                
                // Animations and transitions
                animations: {
                    cssTransitions: checkCSSTransitions(),
                    keyframeAnimations: checkKeyframeAnimations(),
                    hoverEffects: checkHoverEffects()
                }
            };

            console.log('ðŸŽ¨ Visual Display Test Results:', visualTests);
            return visualTests;
        };

        function checkGlassmorphismEffects() {
            const glassElements = document.querySelectorAll('.card, .modal-content, .navbar');
            return Array.from(glassElements).some(el => {
                const style = getComputedStyle(el);
                return style.backdropFilter.includes('blur') || style.background.includes('rgba');
            });
        }

        function checkResponsiveBreakpoints() {
            return window.innerWidth > 768 ? 'desktop' : window.innerWidth > 480 ? 'tablet' : 'mobile';
        }

        function checkCSSTransitions() {
            const elements = document.querySelectorAll('.btn, .card, .tab, .mode-btn');
            return Array.from(elements).some(el => 
                getComputedStyle(el).transition !== 'all 0s ease 0s');
        }

        function checkKeyframeAnimations() {
            const animatedElements = document.querySelectorAll('.spinner, .bg-gradient::before');
            return animatedElements.length > 0;
        }

        function checkHoverEffects() {
            const hoverElements = document.querySelectorAll('.btn, .card, .tab');
            return hoverElements.length > 0;
        }

        // Demo Content Test
        window.testWithDemoContent = function() {
            console.log('ðŸ“ Testing with demo content...');
            
            // Create demo flashcards
            const demoFlashcards = [
                {
                    term: "Artificial Intelligence",
                    definition: "The simulation of human intelligence in machines that are programmed to think and learn.",
                    difficulty: 3,
                    importance: 4,
                    category: "Technology",
                    visualDescription: "Imagine a robot brain with neural networks",
                    mnemonic: "AI = Artificial Intelligence = Amazing Innovation",
                    multipleExamples: ["Machine Learning", "Natural Language Processing", "Computer Vision"],
                    connections: ["Data Science", "Robotics", "Automation"],
                    commonMisconceptions: ["AI will replace all humans", "AI is only for tech companies"]
                }
            ];
            
            // Test flashcard display
            displayFlashcards(demoFlashcards);
            
            // Create demo questions
            const demoQuestions = [
                {
                    question: "What is the primary goal of artificial intelligence?",
                    options: [
                        "To replace human workers",
                        "To simulate human intelligence in machines",
                        "To create robots",
                        "To process data faster"
                    ],
                    correctAnswer: "To simulate human intelligence in machines",
                    explanation: "AI aims to create machines that can perform tasks requiring human-like intelligence."
                }
            ];
            
            // Test question display
            displayQuestions(demoQuestions);
            
            // Test summary display
            const demoSummary = {
                overview: "This is a demonstration of StudyMaster AI's content generation capabilities.",
                difficultyLevel: "Beginner",
                estimatedStudyTime: "15 minutes",
                learningObjectives: [
                    "Understand AI basics",
                    "Learn about machine learning",
                    "Explore practical applications"
                ],
                keyPoints: [
                    "AI simulates human intelligence",
                    "Machine learning is a subset of AI",
                    "AI has many real-world applications"
                ]
            };
            
            displayGeneratedContent({ summary: demoSummary });
            
            console.log('âœ… Demo content loaded successfully');
            return true;
        };

        // Auto-run comprehensive test
        setTimeout(async () => {
            console.log('ðŸš€ AUTO-RUNNING FRONTEND TESTS...');
            
            // Test frontend displays first
            window.testFrontendDisplays();
            
            // Test UI functionality
            window.testUIFunctionality();
            
            // Test visual displays
            window.testVisualDisplays();
            
            // Wait for API to initialize then test connections
            if (window.api) {
                setTimeout(async () => {
                    await window.runFullSystemTest();
                    
                    // Test with demo content
                    setTimeout(() => {
                        window.testWithDemoContent();
                    }, 1000);
                }, 2000);
            }
        }, 1000);

        // Manual test runner accessible from console
        window.runAllFrontendTests = function() {
            console.log('ðŸ§ª RUNNING ALL FRONTEND TESTS MANUALLY...');
            
            const results = {
                elements: window.testFrontendDisplays(),
                ui: window.testUIFunctionality(),
                visuals: window.testVisualDisplays(),
                demoContent: window.testWithDemoContent()
            };
            
            console.log('ðŸ“‹ COMPLETE TEST RESULTS:', results);
            return results;
        };
    </script>
</body>
</html>